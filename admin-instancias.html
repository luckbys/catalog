<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Inst√¢ncias - Evolution API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="evolution-api-config.js"></script>
  <link rel="icon" href="favicon.ico" />
  <style>
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen pb-20 md:pb-0">

  <!-- Auth Overlay -->
  <div id="authOverlay"
    class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
      <div class="text-center mb-6">
        <div
          class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-3">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Acesso Restrito</h2>
        <p class="text-sm text-gray-500">Digite a senha de administrador</p>
      </div>
      <form id="authForm" class="space-y-4">
        <input id="authPassword" type="password"
          class="w-full border-2 border-gray-200 rounded-lg px-4 py-2 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all text-center text-lg"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button type="submit"
          class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-emerald-200">
          Entrar
        </button>
        <div id="authError" class="text-sm text-red-500 text-center hidden font-medium">Senha incorreta</div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"
    class="fixed top-4 right-4 hidden bg-white border-2 border-emerald-200 text-emerald-700 rounded-xl shadow-lg px-4 py-3 z-50 flex items-center gap-2 transition-all duration-300 transform translate-y-0">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M20 6L9 17l-5-5"></path>
    </svg>
    <span id="toastText" class="font-semibold">Sucesso!</span>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-100">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-xl overflow-hidden shadow-sm bg-white border border-gray-100">
            <img src="public/logo.png" alt="Logo" class="w-full h-full object-contain p-1" />
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800 leading-tight">Admin Inst√¢ncias</h1>
            <p class="text-xs text-gray-500 font-medium">Gerenciamento de conex√µes WhatsApp</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="admin-config.html"
            class="p-2 text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors"
            title="Configura√ß√µes">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
              </path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </a>
          <a href="admin-pedidos.html"
            class="p-2 text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors"
            title="Voltar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- Toolbar -->
    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
      <div class="flex items-center gap-2 w-full md:w-auto">
        <button id="addInstanceBtn"
          class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-emerald-200 flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nova Inst√¢ncia
        </button>
        <button id="syncBtn"
          class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition-all hover:-translate-y-0.5"
          title="Sincronizar com Evolution API">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />
          </svg>
          Sincronizar
        </button>
      </div>

      <div class="flex items-center gap-2 w-full md:w-auto">
        <button id="exportBtn"
          class="flex-1 md:flex-none bg-white border border-gray-200 text-gray-600 hover:border-emerald-500 hover:text-emerald-600 font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Exportar
        </button>
        <label
          class="flex-1 md:flex-none bg-white border border-gray-200 text-gray-600 hover:border-emerald-500 hover:text-emerald-600 font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors cursor-pointer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Importar
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </label>
      </div>
    </div>

    <!-- Grid -->
    <div id="instancesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Cards will be injected here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
      <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-4">
        <svg class="text-gray-300" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="1.5">
          <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
          <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
          <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhuma inst√¢ncia configurada</h3>
      <p class="text-gray-500 max-w-xs mx-auto">Adicione sua primeira inst√¢ncia do Evolution API para come√ßar a
        gerenciar.</p>
    </div>

  </main>

  <!-- Modal Form -->
  <div id="formSection"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
        <h3 id="formTitle" class="text-lg font-bold text-gray-800">Nova Inst√¢ncia</h3>
        <button id="cancelBtn" class="text-gray-400 hover:text-gray-600">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome da Inst√¢ncia</label>
            <input id="instanceName" type="text"
              class="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all"
              placeholder="ex.: loja-principal" />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL da API</label>
            <input id="apiUrl" type="url"
              class="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all"
              placeholder="https://api.seudominio.com" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">API Key (Global ou da Inst√¢ncia)</label>
            <input id="apiKey" type="text"
              class="w-full border-2 border-gray-200 rounded-lg px-3 py-2 mono focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all"
              placeholder="Insira a chave de API" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Telefone Vendedor (Opcional)</label>
            <input id="sellerPhone" type="text"
              class="w-full border-2 border-gray-200 rounded-lg px-3 py-2 mono focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all"
              placeholder="5511999999999" />
          </div>
        </div>
      </div>
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
        <button id="saveBtn"
          class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div id="qrModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 transition-opacity opacity-0">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-200"
      id="qrModalContent">
      <div class="p-6 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-2">Escanear QR Code</h3>
        <p class="text-gray-500 text-sm mb-6">Abra o WhatsApp no seu celular e escaneie o c√≥digo abaixo para conectar.
        </p>

        <div id="qrCodeContainer"
          class="flex justify-center mb-6 bg-white p-4 rounded-xl border border-gray-100 shadow-inner min-h-[256px] items-center">
          <div class="animate-pulse flex flex-col items-center gap-2 text-gray-400">
            <svg class="animate-spin h-8 w-8 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            <span>Carregando QR Code...</span>
          </div>
        </div>

        <button id="closeQrBtn"
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2.5 rounded-xl transition-colors">
          Fechar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Gate simples de UI: usa localStorage para n√£o bloquear preview local.
    // Seguran√ßa real √© aplicada pelo backend via cookie e login.
    const authOverlay = document.getElementById('authOverlay');
    const authForm = document.getElementById('authForm');
    const authError = document.getElementById('authError');
    const showAuthOverlayIfNeeded = () => {
      const ok = localStorage.getItem('admin_instancias_auth') === 'ok';
      if (!ok) authOverlay.classList.remove('hidden');
    };
    document.addEventListener('DOMContentLoaded', showAuthOverlayIfNeeded);
    authForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.classList.add('hidden');
      const pwd = document.getElementById('authPassword').value;
      const port = window.location.port;
      const API_BASE = (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
      const loginUrl = API_BASE + '/api/admin-instancias/login';
      console.log('Login Attempt:', { API_BASE, port, loginUrl, time: new Date().toISOString() });
      try {
        const r = await fetch(loginUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
        const j = await r.json();
        if (r.ok && j?.ok) {
          localStorage.setItem('admin_instancias_auth', 'ok');
          authOverlay.classList.add('hidden');
          // recarrega para garantir que qualquer conte√∫do protegido seja reavaliado
          window.location.reload();
          return;
        }
        authError.textContent = j?.error || 'Senha inv√°lida.';
        authError.classList.remove('hidden');
      } catch (err) {
        authError.textContent = 'Erro ao conectar. Tente novamente.';
        authError.classList.remove('hidden');
      }
    });

    const STORAGE_KEY = 'evolution_instances';
    const DEFAULT_KEY = 'EVOLUTION_DEFAULT_INSTANCE';

    let editingId = null;

    const showToast = (text, ok = true) => {
      const el = document.getElementById('toast');
      const txt = document.getElementById('toastText');
      const icon = el.querySelector('svg');

      txt.textContent = text;
      el.classList.remove('hidden');

      // Reset classes
      el.className = `fixed top-4 right-4 bg-white border-2 rounded-xl shadow-lg px-4 py-3 z-50 flex items-center gap-2 transition-all duration-300 transform translate-y-0 ${ok ? 'border-emerald-200 text-emerald-700' : 'border-red-200 text-red-700'}`;

      // Update icon
      if (ok) {
        icon.innerHTML = '<path d="M20 6L9 17l-5-5"></path>';
      } else {
        icon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>';
      }

      setTimeout(() => {
        el.classList.add('hidden');
      }, 3000);
    };

    const maskKey = (k) => {
      if (!k) return '';
      const a = k.slice(0, 4); const b = k.slice(-4);
      return `${a}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢${b}`;
    };

    const loadInstances = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }
    };
    const saveInstances = (list) => localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    const getDefaultId = () => localStorage.getItem(DEFAULT_KEY);
    const setDefaultId = (id) => localStorage.setItem(DEFAULT_KEY, id);

    const saveToBackend = async (list) => {
      try {
        const port = window.location.port;
        const API_BASE = (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
        await fetch(`${API_BASE}/api/evolution/instances`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(list)
        });
      } catch (e) { console.error('Backend sync failed', e); }
    };

    // Semeia automaticamente a inst√¢ncia a partir de evolution-api-config.js, se existir
    const autoSeedFromConfig = () => {
      try {
        // Dispon√≠vel se o script evolution-api-config.js foi carregado
        if (typeof EVOLUTION_CONFIG === 'undefined') return;
        const cfg = EVOLUTION_CONFIG;
        const list = loadInstances();
        const already = list.some(i => i.instanceName === cfg.INSTANCE_NAME);
        if (!already) {
          const id = `cfg-${cfg.INSTANCE_NAME}`;
          const inst = {
            id,
            instanceName: cfg.INSTANCE_NAME,
            apiUrl: cfg.API_URL,
            apiKey: cfg.API_KEY,
            sellerPhone: cfg.SELLER_PHONE || ''
          };
          list.push(inst);
          saveInstances(list);
          if (!getDefaultId()) setDefaultId(id);
        }
        // Sempre sincroniza com backend para garantir consist√™ncia
        saveToBackend(list);
      } catch { }
    };

    const syncFromEvolution = async () => {
      const list = loadInstances();
      // Tenta pegar config de alguma inst√¢ncia existente ou do config global
      let apiUrl = '', apiKey = '';

      if (typeof EVOLUTION_CONFIG !== 'undefined') {
        apiUrl = EVOLUTION_CONFIG.API_URL;
        apiKey = EVOLUTION_CONFIG.API_KEY;
      } else if (list.length > 0) {
        apiUrl = list[0].apiUrl;
        apiKey = list[0].apiKey;
      }

      if (!apiUrl || !apiKey) {
        showToast('Configure ao menos uma inst√¢ncia ou o arquivo config.js', false);
        return;
      }

      showToast('Buscando inst√¢ncias...', true);

      try {
        // Remove barra final se houver
        if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);

        const headers = {
          'apikey': apiKey,
          'x-api-key': apiKey,
          'Authorization': apiKey.startsWith('Bearer ') ? apiKey : `Bearer ${apiKey}`
        };

        const resp = await fetch(`${apiUrl}/instance/fetchInstances`, { headers });
        if (!resp.ok) throw new Error(`Erro API: ${resp.status}`);

        const data = await resp.json();
        const remoteInstances = Array.isArray(data) ? data : (data.instances || []);

        let added = 0;
        remoteInstances.forEach(rem => {
          const name = rem.instance?.instanceName || rem.instanceName || rem.name;
          if (!name) return;

          const exists = list.find(l => l.instanceName === name);
          if (!exists) {
            list.push({
              id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
              instanceName: name,
              apiUrl: apiUrl,
              apiKey: apiKey,
              sellerPhone: ''
            });
            added++;
          }
        });

        if (added > 0) {
          saveInstances(list);
          saveToBackend(list);
          renderInstances();
          showToast(`${added} inst√¢ncias encontradas e adicionadas! üéâ`);
        } else {
          showToast('Nenhuma nova inst√¢ncia encontrada.');
        }

      } catch (e) {
        console.error(e);
        showToast(`Erro ao sincronizar: ${e.message}`, false);
      }
    };

    const tryLoadFromBackend = async () => {
      try {
        const port = window.location.port;
        const API_BASE = (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
        const url = API_BASE + '/api/evolution/instances';
        console.log('LoadBackend:', { API_BASE, url });
        const r = await fetch(url);
        if (!r.ok) return null;
        const data = await r.json();
        return Array.isArray(data) ? data : null;
      } catch { return null; }
    };

    const renderInstances = () => {
      const list = loadInstances();
      const container = document.getElementById('instancesList');
      const empty = document.getElementById('emptyState');

      container.innerHTML = '';
      empty.classList.toggle('hidden', list.length > 0);

      list.forEach((inst) => {
        const isDefault = getDefaultId() === inst.id;
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow overflow-hidden flex flex-col';
        card.innerHTML = `
          <div class="p-5 flex-1">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-bold text-lg text-gray-800 leading-none mb-1">${inst.instanceName}</h3>
                <span id="conn-${inst.id}" class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                  <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                  Checando...
                </span>
              </div>
              ${isDefault ? '<span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">PADR√ÉO</span>' : ''}
            </div>
            
            <div class="space-y-2 text-sm">
              <div class="flex items-center gap-2 text-gray-500">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                <span class="truncate font-mono text-xs bg-gray-50 px-1.5 py-0.5 rounded max-w-[200px] block truncate" title="${inst.apiUrl}">${inst.apiUrl}</span>
              </div>
              <div class="flex items-center gap-2 text-gray-500">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <span class="font-mono text-xs bg-gray-50 px-1.5 py-0.5 rounded">${maskKey(inst.apiKey)}</span>
              </div>
              ${inst.sellerPhone ? `
              <div class="flex items-center gap-2 text-gray-500">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                <span class="font-mono text-xs bg-gray-50 px-1.5 py-0.5 rounded">${inst.sellerPhone}</span>
              </div>` : ''}
            </div>
          </div>

          <div class="bg-gray-50 px-5 py-3 border-t border-gray-100 grid grid-cols-4 gap-2">
            <button data-id="${inst.id}" class="connectBtn col-span-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold py-1.5 rounded-lg transition-colors shadow-sm">
              Conectar
            </button>
            <button data-id="${inst.id}" class="testBtn bg-white border border-gray-200 hover:border-blue-400 hover:text-blue-600 text-gray-600 text-sm font-medium py-1.5 rounded-lg transition-colors" title="Testar Conex√£o">
              <svg class="mx-auto" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
            </button>
            <button data-id="${inst.id}" class="editBtn bg-white border border-gray-200 hover:border-gray-400 text-gray-600 text-sm font-medium py-1.5 rounded-lg transition-colors" title="Editar">
              <svg class="mx-auto" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
          </div>
           <div class="px-5 pb-3 bg-gray-50 flex justify-between items-center text-xs text-gray-400 border-t border-gray-100 pt-2">
              <button data-id="${inst.id}" class="setDefaultBtn hover:text-emerald-600 transition-colors font-medium">Definir Padr√£o</button>
              <div class="flex gap-3">
                <button data-id="${inst.id}" class="disconnectBtn hover:text-orange-600 transition-colors">Desconectar</button>
                <button data-id="${inst.id}" class="deleteBtn hover:text-red-600 transition-colors">Excluir</button>
              </div>
           </div>
        `;
        container.appendChild(card);
        // Atualiza o status de conex√£o da inst√¢ncia
        refreshConnectionState(inst);
      });
    };

    const openForm = (inst = null) => {
      const section = document.getElementById('formSection');
      const title = document.getElementById('formTitle');
      const name = document.getElementById('instanceName');
      const url = document.getElementById('apiUrl');
      const key = document.getElementById('apiKey');
      const phone = document.getElementById('sellerPhone');
      section.classList.remove('hidden');
      title.textContent = inst ? 'Editar Inst√¢ncia' : 'Nova Inst√¢ncia';
      editingId = inst ? inst.id : null;
      name.value = inst?.instanceName || '';
      url.value = inst?.apiUrl || '';
      key.value = inst?.apiKey || '';
      phone.value = inst?.sellerPhone || '';
      name.focus();
    };
    const closeForm = () => {
      document.getElementById('formSection').classList.add('hidden');
      editingId = null;
    };

    const saveForm = async () => {
      const name = document.getElementById('instanceName').value.trim();
      const url = document.getElementById('apiUrl').value.trim();
      const key = document.getElementById('apiKey').value.trim();
      const phone = document.getElementById('sellerPhone').value.trim();
      if (!name || !url || !key) { showToast('Preencha nome, URL e API Key', false); return; }
      const list = loadInstances();
      if (editingId) {
        const idx = list.findIndex(i => i.id === editingId);
        if (idx >= 0) list[idx] = { ...list[idx], instanceName: name, apiUrl: url, apiKey: key, sellerPhone: phone };
      } else {
        const id = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        list.push({ id, instanceName: name, apiUrl: url, apiKey: key, sellerPhone: phone });
      }
      saveInstances(list);
      saveToBackend(list);
      closeForm();
      renderInstances();
      showToast('Inst√¢ncia salva com sucesso!');
    };

    const setDefault = (id) => { setDefaultId(id); renderInstances(); showToast('Inst√¢ncia definida como padr√£o'); };

    const testConnection = async (inst) => {
      try {
        // Ping simples no API URL (melhor que tentar endpoint espec√≠fico)
        const ping = await fetch(inst.apiUrl, { method: 'GET' });
        if (ping.ok) { showToast('API acess√≠vel ‚úÖ'); }
        else { showToast(`API respondeu ${ping.status} ‚ùó`, false); }
      } catch (e) {
        showToast(`Falha de conex√£o: ${e.message}`, false);
      }
    };

    const refreshConnectionState = async (inst) => {
      const badge = document.getElementById(`conn-${inst.id}`);
      if (!badge) return;
      // Estado inicial
      badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span> Checando...';
      badge.className = 'inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600';

      try {
        // 1) Tenta via backend (evita CORS e unifica configs de produ√ß√£o)
        try {
          const port = window.location.port;
          const API_BASE = (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
          const backendUrl = `${API_BASE}/api/evolution/connection-state?instance=${encodeURIComponent(inst.instanceName)}`;
          const bResp = await fetch(backendUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (bResp.ok) {
            const bData = await bResp.json();
            const bConnected = !!bData?.connected;
            const bState = String(bData?.state || '').toLowerCase();
            if (bConnected) {
              badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Conectado';
              badge.className = 'inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
              return; // sucesso, sem necessidade de fallback
            }
            // Se backend respondeu mas n√£o est√° conectado, segue para fallback direto
            if (bState) {
              // mant√©m fallback para tentar confirmar diretamente com a Evolution
            }
          }
        } catch { }

        const headers = {
          'Accept': 'application/json',
          'apikey': inst.apiKey,
          'x-api-key': inst.apiKey,
          'Authorization': inst.apiKey?.startsWith('Bearer ') ? inst.apiKey : `Bearer ${inst.apiKey}`
        };
        const urls = [
          `${inst.apiUrl}/instance/connectionState/${encodeURIComponent(inst.instanceName)}`,
          `${inst.apiUrl}/instance/connectionState?instance=${encodeURIComponent(inst.instanceName)}`,
          `${inst.apiUrl}/instances/${encodeURIComponent(inst.instanceName)}/connectionState`
        ];
        let r = null, data = {};
        for (const u of urls) {
          try {
            const resp = await fetch(u, { method: 'GET', headers });
            r = resp;
            try { data = await resp.json(); } catch { data = {}; }
            if (resp.ok) break;
          } catch { }
        }

        const state = String((data && (data.state || data.status || data.connectionStatus)) || '').toLowerCase();
        const isConnected = (r && r.ok) && (state.includes('connected') || state.includes('open') || data?.connected === true || String(data?.result || '').toLowerCase().includes('connected'));
        if (isConnected) {
          badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Conectado';
          badge.className = 'inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
        } else {
          badge.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> ${state ? state : 'Desconectado'}`;
          badge.className = 'inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700';
        }
      } catch (e) {
        badge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> Offline';
        badge.className = 'inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700';
      }
    };

    const connectInstance = async (inst) => {
      try {
        // Tentativa gen√©rica; muitos provedores usam /instance/connect
        const r = await fetch(`${inst.apiUrl}/instance/connect/${encodeURIComponent(inst.instanceName)}`, { method: 'POST', headers: { 'apikey': inst.apiKey } });
        showToast(r.ok ? 'Inst√¢ncia conectada üéâ' : `Falha ao conectar (${r.status})`, r.ok);
        refreshConnectionState(inst);
      } catch (e) { showToast(`Erro ao conectar: ${e.message}`, false); }
    };

    const disconnectInstance = async (inst) => {
      try {
        // Evolution API usa /instance/logout para desconectar o WhatsApp
        const r = await fetch(`${inst.apiUrl}/instance/logout/${encodeURIComponent(inst.instanceName)}`, { method: 'DELETE', headers: { 'apikey': inst.apiKey } });
        showToast(r.ok ? 'Inst√¢ncia desconectada üëã' : `Falha ao desconectar (${r.status})`, r.ok);
        refreshConnectionState(inst);
      } catch (e) { showToast(`Erro ao desconectar: ${e.message}`, false); }
    };

    const wireEvents = () => {
      document.getElementById('addInstanceBtn').addEventListener('click', () => openForm());
      document.getElementById('syncBtn').addEventListener('click', syncFromEvolution);
      document.getElementById('cancelBtn').addEventListener('click', closeForm);
      document.getElementById('saveBtn').addEventListener('click', saveForm);
      document.getElementById('closeQrBtn').addEventListener('click', closeQrModal);
      document.getElementById('exportBtn').addEventListener('click', () => {
        const data = JSON.stringify(loadInstances(), null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'evolution-instances.json'; a.click();
        URL.revokeObjectURL(url);
      });
      document.getElementById('importInput').addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          if (Array.isArray(data)) {
            saveInstances(data);
            saveToBackend(data);
            renderInstances();
            showToast('Inst√¢ncias importadas üëç');
          }
          else showToast('JSON inv√°lido', false);
        } catch { showToast('Falha ao importar JSON', false); }
        e.target.value = '';
      });
    };

    const wireListActions = () => {
      const container = document.getElementById('instancesList');
      container.addEventListener('click', (evt) => {
        const btn = evt.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const list = loadInstances();
        const inst = list.find(i => i.id === id);
        if (!inst) return;
        if (btn.classList.contains('setDefaultBtn')) setDefault(id);
        else if (btn.classList.contains('testBtn')) testConnection(inst);
        else if (btn.classList.contains('connectBtn')) connectInstance(inst);
        else if (btn.classList.contains('disconnectBtn')) disconnectInstance(inst);
        else if (btn.classList.contains('editBtn')) openForm(inst);
        else if (btn.classList.contains('deleteBtn')) {
          const newList = list.filter(i => i.id !== id);
          saveInstances(newList);
          saveToBackend(newList);
          if (getDefaultId() === id) setDefaultId('');
          renderInstances();
          showToast('Inst√¢ncia exclu√≠da üóëÔ∏è');
        }
      });
    };

    document.addEventListener('DOMContentLoaded', async () => {
      wireEvents();
      wireListActions();
      const backendData = await tryLoadFromBackend();
      if (backendData) { saveInstances(backendData); }
      // Caso n√£o haja dados do backend, puxa da config local
      autoSeedFromConfig();
      renderInstances();
    });
  </script>
</body>

</html>