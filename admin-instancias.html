<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Inst√¢ncias - Evolution API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="evolution-api-config.js"></script>
  <link rel="icon" href="favicon.ico" />
  <style>
    .card { border-width: 2px; }
    .badge { font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen">
  <!-- Gate de senha (overlay) -->
  <div id="authOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl border-2 border-gray-200 w-full max-w-sm p-5">
        <h2 class="text-lg font-bold text-gray-800 mb-2">Prote√ß√£o ‚Äî Admin Inst√¢ncias</h2>
        <p class="text-sm text-gray-600 mb-4">Digite a senha para continuar.</p>
        <form id="authForm" class="space-y-3">
          <div>
            <label class="text-xs font-semibold text-gray-700">Senha</label>
            <input id="authPassword" type="password" class="mt-1 w-full border-2 border-gray-200 rounded-lg px-3 py-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <button class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg w-full justify-center" type="submit">
            Entrar
          </button>
          <div id="authError" class="text-sm text-red-600 hidden">Senha inv√°lida. Tente novamente.</div>
        </form>
      </div>
    </div>
  </div>
  <!-- Notification -->
  <div id="toast" class="fixed top-4 right-4 hidden bg-white border-2 border-emerald-200 text-emerald-700 rounded-xl shadow-lg px-4 py-3 z-50">
    <div class="flex items-center gap-2">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>
      <span id="toastText" class="text-sm font-semibold">Tudo certo!</span>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-xl overflow-hidden shadow-lg bg-white">
            <img src="public/logo.png" alt="Logo" class="w-full h-full object-contain p-1" />
          </div>
          <div>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Admin Inst√¢ncias ‚Äî WhatsApp</h1>
            <p class="text-sm text-gray-600">Gerencie conex√µes e cadastre novas inst√¢ncias</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="admin-pedidos.html" class="inline-flex items-center justify-center w-10 h-10 rounded-lg border-2 border-gray-200 text-gray-600 bg-white hover:border-emerald-500 hover:text-emerald-600" title="Voltar para Admin Pedidos" aria-label="Voltar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"></path></svg>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 py-8">
    <!-- Actions -->
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <button id="addInstanceBtn" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg w-full sm:w-auto justify-center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"></path></svg>
        Nova Inst√¢ncia
      </button>
      <button id="exportBtn" class="inline-flex items-center gap-2 bg-white text-gray-700 border-2 border-gray-200 hover:border-gray-300 font-semibold py-2 px-3 rounded-lg w-full sm:w-auto justify-center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v8m0 0l-3-3m3 3l3-3"></path><path d="M20 19H4a2 2 0 01-2-2V7a2 2 0 012-2h7l2 2h7a2 2 0 012 2v8a2 2 0 01-2 2z"></path></svg>
        Exportar JSON
      </button>
      <label class="inline-flex items-center gap-2 bg-white text-gray-700 border-2 border-gray-200 hover:border-gray-300 font-semibold py-2 px-3 rounded-lg cursor-pointer w-full sm:w-auto justify-center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h16"></path></svg>
        Importar JSON
        <input id="importInput" type="file" accept="application/json" class="hidden" />
      </label>
    </div>

    <!-- Instances List -->
    <section class="bg-white rounded-2xl p-4 shadow-md card border-gray-200 mb-6">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <h2 class="text-lg font-bold text-gray-800">Inst√¢ncias Configuradas</h2>
        <span id="instancesCount" class="text-sm text-gray-500 w-full sm:w-auto text-right sm:text-left">0 inst√¢ncias</span>
      </div>
      <div id="instancesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="emptyState" class="hidden text-center py-12">
        <div class="text-6xl mb-2">üîå</div>
        <p class="text-gray-700 font-bold mb-1">Nenhuma inst√¢ncia configurada</p>
        <p class="text-gray-500">Clique em ‚ÄúNova Inst√¢ncia‚Äù para adicionar</p>
      </div>
    </section>

    <!-- Add/Edit Form -->
    <section id="formSection" class="hidden bg-white rounded-2xl p-4 shadow-md card border-emerald-200">
      <h3 id="formTitle" class="text-lg font-bold text-gray-800 mb-3">Nova Inst√¢ncia</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-semibold text-gray-700">Nome da Inst√¢ncia</label>
          <input id="instanceName" type="text" class="mt-1 w-full border-2 border-gray-200 rounded-lg px-3 py-2" placeholder="ex.: hakim, loja1" />
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">API URL</label>
          <input id="apiUrl" type="url" class="mt-1 w-full border-2 border-gray-200 rounded-lg px-3 py-2" placeholder="https://evo.devsible.com.br" />
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">API Key</label>
          <input id="apiKey" type="text" class="mt-1 w-full border-2 border-gray-200 rounded-lg px-3 py-2 mono" placeholder="chave secreta" />
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">Telefone do Vendedor (opcional)</label>
          <input id="sellerPhone" type="text" class="mt-1 w-full border-2 border-gray-200 rounded-lg px-3 py-2 mono" placeholder="5511999999999" />
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2 mt-4">
        <button id="saveBtn" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg w-full sm:w-auto justify-center">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>
          Salvar
        </button>
        <button id="cancelBtn" class="inline-flex items-center gap-2 bg-white text-gray-700 border-2 border-gray-200 hover:border-gray-300 font-semibold py-2 px-3 rounded-lg w-full sm:w-auto justify-center">Cancelar</button>
      </div>
    </section>
  </main>

  <script>
    // Gate simples de UI: usa localStorage para n√£o bloquear preview local.
    // Seguran√ßa real √© aplicada pelo backend via cookie e login.
    const authOverlay = document.getElementById('authOverlay');
    const authForm = document.getElementById('authForm');
    const authError = document.getElementById('authError');
    const showAuthOverlayIfNeeded = () => {
      const ok = localStorage.getItem('admin_instancias_auth') === 'ok';
      if (!ok) authOverlay.classList.remove('hidden');
    };
    document.addEventListener('DOMContentLoaded', showAuthOverlayIfNeeded);
    authForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.classList.add('hidden');
      const pwd = document.getElementById('authPassword').value;
      try {
        const r = await fetch('/api/admin-instancias/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
        const j = await r.json();
        if (r.ok && j?.ok) {
          localStorage.setItem('admin_instancias_auth', 'ok');
          authOverlay.classList.add('hidden');
          // recarrega para garantir que qualquer conte√∫do protegido seja reavaliado
          window.location.reload();
          return;
        }
        authError.textContent = j?.error || 'Senha inv√°lida.';
        authError.classList.remove('hidden');
      } catch (err) {
        authError.textContent = 'Erro ao conectar. Tente novamente.';
        authError.classList.remove('hidden');
      }
    });

    const STORAGE_KEY = 'evolution_instances';
    const DEFAULT_KEY = 'EVOLUTION_DEFAULT_INSTANCE';

    let editingId = null;

    const showToast = (text, ok = true) => {
      const el = document.getElementById('toast');
      const txt = document.getElementById('toastText');
      txt.textContent = text;
      el.classList.remove('hidden');
      el.classList.toggle('border-emerald-200', ok);
      el.classList.toggle('text-emerald-700', ok);
      el.classList.toggle('border-red-200', !ok);
      el.classList.toggle('text-red-700', !ok);
      setTimeout(() => el.classList.add('hidden'), 2500);
    };

    const maskKey = (k) => {
      if (!k) return '';
      const a = k.slice(0, 4); const b = k.slice(-4);
      return `${a}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢${b}`;
    };

    const loadInstances = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }
    };
    const saveInstances = (list) => localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    const getDefaultId = () => localStorage.getItem(DEFAULT_KEY);
    const setDefaultId = (id) => localStorage.setItem(DEFAULT_KEY, id);

    // Semeia automaticamente a inst√¢ncia a partir de evolution-api-config.js, se existir
    const autoSeedFromConfig = () => {
      try {
        // Dispon√≠vel se o script evolution-api-config.js foi carregado
        if (typeof EVOLUTION_CONFIG === 'undefined') return;
        const cfg = EVOLUTION_CONFIG;
        const list = loadInstances();
        const already = list.some(i => i.instanceName === cfg.INSTANCE_NAME);
        if (!already) {
          const id = `cfg-${cfg.INSTANCE_NAME}`;
          const inst = {
            id,
            instanceName: cfg.INSTANCE_NAME,
            apiUrl: cfg.API_URL,
            apiKey: cfg.API_KEY,
            sellerPhone: cfg.SELLER_PHONE || ''
          };
          list.push(inst);
          saveInstances(list);
          if (!getDefaultId()) setDefaultId(id);
        }
      } catch {}
    };

    const tryLoadFromBackend = async () => {
      try {
        const r = await fetch('/api/evolution/instances');
        if (!r.ok) return null;
        const data = await r.json();
        return Array.isArray(data) ? data : null;
      } catch { return null; }
    };

    const renderInstances = () => {
      const list = loadInstances();
      const container = document.getElementById('instancesList');
      const empty = document.getElementById('emptyState');
      const count = document.getElementById('instancesCount');
      container.innerHTML = '';
      count.textContent = `${list.length} inst√¢ncia${list.length === 1 ? '' : 's'}`;
      empty.classList.toggle('hidden', list.length > 0);
      list.forEach((inst) => {
        const isDefault = getDefaultId() === inst.id;
        const card = document.createElement('div');
        card.className = 'rounded-xl border-2 border-gray-200 bg-white p-4 shadow-sm';
        card.innerHTML = `
          <div class="flex flex-col sm:flex-row items-start justify-between gap-2 mb-2">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-lg font-bold text-gray-800">${inst.instanceName}</span>
                ${isDefault ? '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-bold">Padr√£o</span>' : ''}
                <span id="conn-${inst.id}" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 font-bold">Checando...</span>
              </div>
              <p class="text-sm text-gray-600 mono break-all">${inst.apiUrl}</p>
              <p class="text-sm text-gray-600 mono break-all">${maskKey(inst.apiKey)}</p>
              ${inst.sellerPhone ? `<p class="text-sm text-gray-600 mono break-all">Vendedor: ${inst.sellerPhone}</p>` : ''}
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2 sm:mt-0 w-full sm:w-auto sm:ml-4">
              <button data-id="${inst.id}" class="setDefaultBtn inline-flex items-center gap-1 bg-white text-gray-700 border-2 border-gray-200 hover:border-emerald-500 hover:text-emerald-600 font-semibold py-1 px-2 rounded-lg text-sm w-full sm:w-auto justify-center" title="Definir como padr√£o">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3 7h7l-5.5 4 2.5 7-6-4.5L7.5 20 10 13 4 9h7z"></path></svg>
                Padr√£o
              </button>
              <button data-id="${inst.id}" class="testBtn inline-flex items-center gap-1 bg-white text-gray-700 border-2 border-gray-200 hover:border-blue-500 hover:text-blue-600 font-semibold py-1 px-2 rounded-lg text-sm w-full sm:w-auto justify-center" title="Testar conex√£o">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18"></path><path d="M12 3v18"></path></svg>
                Testar
              </button>
              <button data-id="${inst.id}" class="connectBtn inline-flex items-center gap-1 bg-white text-gray-700 border-2 border-gray-200 hover:border-purple-500 hover:text-purple-600 font-semibold py-1 px-2 rounded-lg text-sm w-full sm:w-auto justify-center" title="Conectar inst√¢ncia">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                Conectar
              </button>
              <button data-id="${inst.id}" class="disconnectBtn inline-flex items-center gap-1 bg-white text-gray-700 border-2 border-gray-200 hover:border-orange-500 hover:text-orange-600 font-semibold py-1 px-2 rounded-lg text-sm w-full sm:w-auto justify-center" title="Desconectar inst√¢ncia">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"></path></svg>
                Desconectar
              </button>
              <button data-id="${inst.id}" class="editBtn inline-flex items-center gap-1 bg-white text-gray-700 border-2 border-gray-200 hover:border-gray-400 font-semibold py-1 px-2 rounded-lg text-sm w-full sm:w-auto justify-center" title="Editar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
                Editar
              </button>
              <button data-id="${inst.id}" class="deleteBtn inline-flex items-center gap-1 bg-white text-gray-700 border-2 border-red-300 hover:border-red-500 hover:text-red-600 font-semibold py-1 px-2 rounded-lg text-sm w-full sm:w-auto justify-center" title="Excluir">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M8 6V4h8v2"></path><path d="M19 6l-1 14H6L5 6"></path></svg>
                Excluir
              </button>
            </div>
          </div>
        `;
        container.appendChild(card);
        // Atualiza o status de conex√£o da inst√¢ncia
        refreshConnectionState(inst);
      });
    };

    const openForm = (inst = null) => {
      const section = document.getElementById('formSection');
      const title = document.getElementById('formTitle');
      const name = document.getElementById('instanceName');
      const url = document.getElementById('apiUrl');
      const key = document.getElementById('apiKey');
      const phone = document.getElementById('sellerPhone');
      section.classList.remove('hidden');
      title.textContent = inst ? 'Editar Inst√¢ncia' : 'Nova Inst√¢ncia';
      editingId = inst ? inst.id : null;
      name.value = inst?.instanceName || '';
      url.value = inst?.apiUrl || '';
      key.value = inst?.apiKey || '';
      phone.value = inst?.sellerPhone || '';
      name.focus();
    };
    const closeForm = () => {
      document.getElementById('formSection').classList.add('hidden');
      editingId = null;
    };

    const saveForm = async () => {
      const name = document.getElementById('instanceName').value.trim();
      const url = document.getElementById('apiUrl').value.trim();
      const key = document.getElementById('apiKey').value.trim();
      const phone = document.getElementById('sellerPhone').value.trim();
      if (!name || !url || !key) { showToast('Preencha nome, URL e API Key', false); return; }
      const list = loadInstances();
      if (editingId) {
        const idx = list.findIndex(i => i.id === editingId);
        if (idx >= 0) list[idx] = { ...list[idx], instanceName: name, apiUrl: url, apiKey: key, sellerPhone: phone };
      } else {
        const id = `${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
        list.push({ id, instanceName: name, apiUrl: url, apiKey: key, sellerPhone: phone });
      }
      saveInstances(list);
      try {
        await fetch('/api/evolution/instances', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(list) });
      } catch {}
      closeForm();
      renderInstances();
      showToast('Inst√¢ncia salva com sucesso!');
    };

    const setDefault = (id) => { setDefaultId(id); renderInstances(); showToast('Inst√¢ncia definida como padr√£o'); };

    const testConnection = async (inst) => {
      try {
        // Ping simples no API URL (melhor que tentar endpoint espec√≠fico)
        const ping = await fetch(inst.apiUrl, { method: 'GET' });
        if (ping.ok) { showToast('API acess√≠vel ‚úÖ'); }
        else { showToast(`API respondeu ${ping.status} ‚ùó`, false); }
      } catch (e) {
        showToast(`Falha de conex√£o: ${e.message}`, false);
      }
    };

    const refreshConnectionState = async (inst) => {
      const badge = document.getElementById(`conn-${inst.id}`);
      if (!badge) return;
      // Estado inicial
      badge.textContent = 'Checando...';
      badge.classList.remove('bg-emerald-100','text-emerald-700','bg-red-100','text-red-700');
      badge.classList.add('bg-gray-100','text-gray-700');

      try {
        // 1) Tenta via backend (evita CORS e unifica configs de produ√ß√£o)
        try {
          const backendUrl = `/api/evolution/connection-state?instance=${encodeURIComponent(inst.instanceName)}`;
          const bResp = await fetch(backendUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (bResp.ok) {
            const bData = await bResp.json();
            const bConnected = !!bData?.connected;
            const bState = String(bData?.state || '').toLowerCase();
            if (bConnected) {
              badge.textContent = 'Conectado';
              badge.classList.remove('bg-gray-100','text-gray-700','bg-red-100','text-red-700');
              badge.classList.add('bg-emerald-100','text-emerald-700');
              return; // sucesso, sem necessidade de fallback
            }
            // Se backend respondeu mas n√£o est√° conectado, segue para fallback direto
            if (bState) {
              // mant√©m fallback para tentar confirmar diretamente com a Evolution
            }
          }
        } catch {}

        const headers = {
          'Accept': 'application/json',
          'apikey': inst.apiKey,
          'x-api-key': inst.apiKey,
          'Authorization': inst.apiKey?.startsWith('Bearer ') ? inst.apiKey : `Bearer ${inst.apiKey}`
        };
        const urls = [
          `${inst.apiUrl}/instance/connectionState/${encodeURIComponent(inst.instanceName)}`,
          `${inst.apiUrl}/instance/connectionState?instance=${encodeURIComponent(inst.instanceName)}`,
          `${inst.apiUrl}/instances/${encodeURIComponent(inst.instanceName)}/connectionState`
        ];
        let r = null, data = {};
        for (const u of urls) {
          try {
            const resp = await fetch(u, { method: 'GET', headers });
            r = resp;
            try { data = await resp.json(); } catch { data = {}; }
            if (resp.ok) break;
          } catch {}
        }

        const state = String((data && (data.state || data.status || data.connectionStatus)) || '').toLowerCase();
        const isConnected = (r && r.ok) && (state.includes('connected') || state.includes('open') || data?.connected === true || String(data?.result || '').toLowerCase().includes('connected'));
        if (isConnected) {
          badge.textContent = 'Conectado';
          badge.classList.remove('bg-gray-100','text-gray-700','bg-red-100','text-red-700');
          badge.classList.add('bg-emerald-100','text-emerald-700');
        } else {
          badge.textContent = state ? `Status: ${state}` : 'Desconectado';
          badge.classList.remove('bg-gray-100','text-gray-700','bg-emerald-100','text-emerald-700');
          badge.classList.add('bg-red-100','text-red-700');
        }
      } catch (e) {
        badge.textContent = 'Offline';
        badge.classList.remove('bg-gray-100','text-gray-700','bg-emerald-100','text-emerald-700');
        badge.classList.add('bg-red-100','text-red-700');
      }
    };

    const connectInstance = async (inst) => {
      try {
        // Tentativa gen√©rica; muitos provedores usam /instance/connect
        const r = await fetch(`${inst.apiUrl}/instance/connect/${encodeURIComponent(inst.instanceName)}`, { method: 'POST', headers: { 'apikey': inst.apiKey } });
        showToast(r.ok ? 'Inst√¢ncia conectada üéâ' : `Falha ao conectar (${r.status})`, r.ok);
        refreshConnectionState(inst);
      } catch (e) { showToast(`Erro ao conectar: ${e.message}`, false); }
    };

    const disconnectInstance = async (inst) => {
      try {
        const r = await fetch(`${inst.apiUrl}/instance/disconnect/${encodeURIComponent(inst.instanceName)}`, { method: 'POST', headers: { 'apikey': inst.apiKey } });
        showToast(r.ok ? 'Inst√¢ncia desconectada üëã' : `Falha ao desconectar (${r.status})`, r.ok);
        refreshConnectionState(inst);
      } catch (e) { showToast(`Erro ao desconectar: ${e.message}`, false); }
    };

    const wireEvents = () => {
      document.getElementById('addInstanceBtn').addEventListener('click', () => openForm());
      document.getElementById('cancelBtn').addEventListener('click', closeForm);
      document.getElementById('saveBtn').addEventListener('click', saveForm);
      document.getElementById('exportBtn').addEventListener('click', () => {
        const data = JSON.stringify(loadInstances(), null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'evolution-instances.json'; a.click();
        URL.revokeObjectURL(url);
      });
      document.getElementById('importInput').addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          if (Array.isArray(data)) { saveInstances(data); renderInstances(); showToast('Inst√¢ncias importadas üëç'); }
          else showToast('JSON inv√°lido', false);
        } catch { showToast('Falha ao importar JSON', false); }
        e.target.value = '';
      });
    };

    const wireListActions = () => {
      const container = document.getElementById('instancesList');
      container.addEventListener('click', (evt) => {
        const btn = evt.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const list = loadInstances();
        const inst = list.find(i => i.id === id);
        if (!inst) return;
        if (btn.classList.contains('setDefaultBtn')) setDefault(id);
        else if (btn.classList.contains('testBtn')) testConnection(inst);
        else if (btn.classList.contains('connectBtn')) connectInstance(inst);
        else if (btn.classList.contains('disconnectBtn')) disconnectInstance(inst);
        else if (btn.classList.contains('editBtn')) openForm(inst);
        else if (btn.classList.contains('deleteBtn')) {
          const newList = list.filter(i => i.id !== id);
          saveInstances(newList);
          if (getDefaultId() === id) setDefaultId('');
          renderInstances();
          showToast('Inst√¢ncia exclu√≠da üóëÔ∏è');
        }
      });
    };

    document.addEventListener('DOMContentLoaded', async () => {
      wireEvents();
      wireListActions();
      const backendData = await tryLoadFromBackend();
      if (backendData) { saveInstances(backendData); }
      // Caso n√£o haja dados do backend, puxa da config local
      autoSeedFromConfig();
      renderInstances();
    });
  </script>
</body>
</html>