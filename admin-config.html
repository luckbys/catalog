<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configura√ß√£o de Contatos - Evolution API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="favicon.ico" />
  <style>
    .card {
      border-width: 2px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen">

  <!-- Notification -->
  <div id="toast"
    class="fixed top-4 right-4 hidden bg-white border-2 border-emerald-200 text-emerald-700 rounded-xl shadow-lg px-4 py-3 z-50">
    <div class="flex items-center gap-2">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 6L9 17l-5-5"></path>
      </svg>
      <span id="toastText" class="text-sm font-semibold">Tudo certo!</span>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-xl overflow-hidden shadow-lg bg-white">
            <img src="public/logo.png" alt="Logo" class="w-full h-full object-contain p-1" />
          </div>
          <div>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Configura√ß√£o de Contatos</h1>
            <p class="text-sm text-gray-600">Gerencie n√∫meros de vendedores e entregadores</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="admin-instancias.html"
            class="inline-flex items-center justify-center w-10 h-10 rounded-lg border-2 border-gray-200 text-gray-600 bg-white hover:border-emerald-500 hover:text-emerald-600"
            title="Ir para Admin Inst√¢ncias" aria-label="Voltar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 py-8">
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Vendedores -->
      <section class="bg-white rounded-2xl p-4 shadow-md card border-gray-200">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-2xl">üì£</span>
          <h2 class="text-lg font-bold text-gray-800">Vendedores</h2>
        </div>
        <p class="text-sm text-gray-500 mb-4">Informe n√∫meros no formato <code>5511999999999</code> (com DDI e DDD).</p>

        <div id="sellers-list" class="space-y-3"></div>

        <button id="add-seller"
          class="mt-4 inline-flex items-center gap-2 bg-white text-gray-700 border-2 border-gray-200 hover:border-emerald-500 hover:text-emerald-600 font-semibold py-2 px-3 rounded-lg w-full justify-center border-dashed">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
          Adicionar vendedor
        </button>
      </section>

      <!-- Entregadores -->
      <section class="bg-white rounded-2xl p-4 shadow-md card border-gray-200">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-2xl">üöö</span>
          <h2 class="text-lg font-bold text-gray-800">Entregadores</h2>
        </div>
        <p class="text-sm text-gray-500 mb-4">Informe n√∫meros no formato <code>5511999999999</code> (com DDI e DDD).</p>

        <div id="drivers-list" class="space-y-3"></div>

        <button id="add-driver"
          class="mt-4 inline-flex items-center gap-2 bg-white text-gray-700 border-2 border-gray-200 hover:border-emerald-500 hover:text-emerald-600 font-semibold py-2 px-3 rounded-lg w-full justify-center border-dashed">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
          Adicionar entregador
        </button>
      </section>
    </div>

    <!-- Footer Actions -->
    <div
      class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg md:static md:bg-transparent md:border-0 md:shadow-none md:p-0 md:mt-8">
      <div class="container mx-auto flex items-center justify-end gap-3">
        <button id="reload"
          class="inline-flex items-center gap-2 bg-white text-gray-700 border-2 border-gray-200 hover:border-gray-300 font-semibold py-2 px-4 rounded-lg">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
          </svg>
          Recarregar
        </button>
        <button id="save"
          class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-6 rounded-lg shadow-lg shadow-emerald-200">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <path d="M17 21v-8H7v8"></path>
            <path d="M7 3v5h8"></path>
          </svg>
          Salvar altera√ß√µes
        </button>
      </div>
    </div>
  </main>

  <script>
    const sellersList = document.getElementById('sellers-list');
    const driversList = document.getElementById('drivers-list');

    const showToast = (text, ok = true) => {
      const el = document.getElementById('toast');
      const txt = document.getElementById('toastText');
      const icon = el.querySelector('svg');

      txt.textContent = text;
      el.classList.remove('hidden');

      // Reset classes
      el.className = `fixed top-4 right-4 bg-white border-2 rounded-xl shadow-lg px-4 py-3 z-50 transition-all duration-300 transform translate-y-0 ${ok ? 'border-emerald-200 text-emerald-700' : 'border-red-200 text-red-700'}`;

      // Update icon
      if (ok) {
        icon.innerHTML = '<path d="M20 6L9 17l-5-5"></path>';
      } else {
        icon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>';
      }

      setTimeout(() => {
        el.classList.add('hidden');
      }, 3000);
    };

    const isValidPhone = (p) => /^[0-9]{11,}$/i.test((p || '').trim());

    function rowTemplate(value = '') {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2 group';

      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'relative flex-1';

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'w-full border-2 border-gray-200 rounded-lg px-3 py-2 mono focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition-all';
      input.placeholder = '5511999999999';
      input.value = value || '';

      input.addEventListener('input', () => {
        const valid = isValidPhone(input.value);
        if (!valid && input.value.length > 0) {
          input.classList.add('border-red-300', 'bg-red-50');
          input.classList.remove('border-gray-200');
        } else {
          input.classList.remove('border-red-300', 'bg-red-50');
          input.classList.add('border-gray-200');
        }
      });

      const removeBtn = document.createElement('button');
      removeBtn.className = 'p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors';
      removeBtn.title = 'Remover';
      removeBtn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      `;
      removeBtn.addEventListener('click', () => {
        div.style.opacity = '0';
        div.style.transform = 'translateX(20px)';
        setTimeout(() => div.remove(), 200);
      });
      div.style.transition = 'all 0.2s ease-out';

      inputWrapper.appendChild(input);
      div.appendChild(inputWrapper);
      div.appendChild(removeBtn);
      return div;
    }

    function render(listEl, values = []) {
      listEl.innerHTML = '';
      if (!values.length) values = [''];
      values.forEach(v => listEl.appendChild(rowTemplate(v)));
    }

    function collect(listEl) {
      return Array.from(listEl.querySelectorAll('input[type=text]'))
        .map(i => (i.value || '').trim())
        .filter(v => v)
        .filter(isValidPhone);
    }

    async function loadConfig() {
      try {
        const port = window.location.port;
        const API_BASE = (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
        const url = API_BASE + '/api/config/contacts';
        console.log('LoadConfig:', { API_BASE, url });

        // showToast('Carregando...', true);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Falha ao carregar configura√ß√£o');
        const data = await res.json();
        render(sellersList, data.seller_phones || []);
        render(driversList, data.driver_phones || []);
        showToast('Configura√ß√£o carregada ‚úÖ');
      } catch (e) {
        console.error(e);
        showToast('Erro ao carregar configura√ß√£o ‚ùå', false);
      }
    }

    async function saveConfig() {
      const seller_phones = collect(sellersList);
      const driver_phones = collect(driversList);

      if (!seller_phones.length && !driver_phones.length) {
        showToast('Informe ao menos um n√∫mero v√°lido', false);
        return;
      }

      try {
        const port = window.location.port;
        const API_BASE = (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
        const url = API_BASE + '/api/config/contacts';

        const res = await fetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ seller_phones, driver_phones })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao salvar');
        showToast('Configura√ß√£o salva com sucesso! üéâ');
      } catch (e) {
        console.error(e);
        showToast('Erro ao salvar configura√ß√£o ‚ùå', false);
      }
    }

    document.getElementById('add-seller').addEventListener('click', () => {
      const row = rowTemplate('');
      sellersList.appendChild(row);
      row.querySelector('input').focus();
    });

    document.getElementById('add-driver').addEventListener('click', () => {
      const row = rowTemplate('');
      driversList.appendChild(row);
      row.querySelector('input').focus();
    });

    document.getElementById('reload').addEventListener('click', loadConfig);
    document.getElementById('save').addEventListener('click', saveConfig);

    // Inicializa√ß√£o
    loadConfig();
  </script>
</body>

</html>