<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monte seu Pedido - Farmácia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .product-card, .cart {
            transition: all 0.3s ease-in-out;
        }
        #deliveryModal.flex {
            display: flex;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">Sua Farmácia de Confiança</h1>
            <p class="text-lg text-slate-600 mt-2">Selecione os produtos abaixo para montar o seu pedido.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna de Produtos -->
            <div class="lg:col-span-3">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Produtos Disponíveis</h2>
                <div class="mb-4">
                    <label for="searchInput" class="sr-only">Buscar produtos</label>
                    <input id="searchInput" type="text" placeholder="Buscar produtos..." class="w-full md:w-96 border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Os produtos serão inseridos aqui pelo JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Cart Drawer -->
    <div id="cartDrawer" class="fixed top-0 right-0 h-full w-full max-w-sm bg-white shadow-2xl z-[100] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-2xl font-semibold flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                Seu Pedido
            </h2>
            <button id="closeCartBtn" class="p-2 rounded-full hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div id="cartItems" class="flex-grow overflow-y-auto p-4">
            <p id="emptyCartMessage" class="text-slate-500 text-center py-4">Seu carrinho está vazio.</p>
            <div id="cartItemsList" class="space-y-4"></div>
        </div>
        <div class="p-4 border-t mt-auto bg-white">
            <div class="flex justify-between items-center text-xl font-bold">
                <span>Total:</span>
                <span id="cartTotal">R$ 0,00</span>
            </div>
            <button id="openDeliveryModalBtn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-green-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                Finalizar Pedido
            </button>
        </div>
    </div>
    
    <!-- Delivery Details Modal -->
    <div id="deliveryModal" role="dialog" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-60 z-[102] hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Informações para Entrega</h2>
            <form id="deliveryForm">
                <div class="mb-4">
                    <label for="customerName" class="block text-slate-700 text-sm font-bold mb-2">Nome Completo</label>
                    <input type="text" id="customerName" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div class="sm:col-span-1">
                        <label for="customerCep" class="block text-slate-700 text-sm font-bold mb-2">CEP</label>
                         <div class="flex items-center">
                            <input type="text" id="customerCep" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required maxlength="9" inputmode="numeric" pattern="\d{5}-?\d{3}" title="CEP deve ter 8 dígitos" autocomplete="postal-code">
                            <span id="cep-loading" class="ml-2 text-sm hidden">Buscando...</span>
                        </div>
                    </div>
                     <div class="sm:col-span-2">
                        <label for="customerStreet" class="block text-slate-700 text-sm font-bold mb-2">Rua / Logradouro</label>
                        <input type="text" id="customerStreet" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline bg-slate-100" readonly required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="customerNumber" class="block text-slate-700 text-sm font-bold mb-2">Número</label>
                        <input type="text" id="customerNumber" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required inputmode="numeric" pattern="\d+" title="Informe apenas números">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="customerComplement" class="block text-slate-700 text-sm font-bold mb-2">Complemento <span class="text-xs font-light">(Opcional)</span></label>
                        <input type="text" id="customerComplement" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Apto, Bloco, Casa">
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="customerNeighborhood" class="block text-slate-700 text-sm font-bold mb-2">Bairro</label>
                        <input type="text" id="customerNeighborhood" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline bg-slate-100" readonly required>
                    </div>
                     <div>
                        <label for="customerCity" class="block text-slate-700 text-sm font-bold mb-2">Cidade</label>
                        <input type="text" id="customerCity" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline bg-slate-100" readonly required>
                    </div>
                     <div>
                        <label for="customerState" class="block text-slate-700 text-sm font-bold mb-2">Estado</label>
                        <input type="text" id="customerState" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline bg-slate-100" readonly required>
                    </div>
                </div>
                
                <!-- Forma de Pagamento -->
                <div class="mb-6">
                    <label class="block text-slate-700 text-sm font-bold mb-3">Forma de Pagamento</label>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="paymentMethod" value="dinheiro" class="mr-3 text-blue-600" required>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                <span class="font-medium">Dinheiro</span>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="paymentMethod" value="pix" class="mr-3 text-blue-600" required>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m9 9 5 5v-5h-5"></path></svg>
                                <span class="font-medium">PIX</span>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="paymentMethod" value="cartao_credito" class="mr-3 text-blue-600" required>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-purple-600"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                <span class="font-medium">Cartão de Crédito</span>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                            <input type="radio" name="paymentMethod" value="cartao_debito" class="mr-3 text-blue-600" required>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-orange-600"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                <span class="font-medium">Cartão de Débito</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="flex items-center justify-end gap-4">
                    <button type="button" id="cancelDeliveryBtn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors">
                        Confirmar e Enviar via WhatsApp
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overlay for Drawer -->
    <div id="cartOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[99] hidden transition-opacity duration-300"></div>

    <!-- Floating Action Button (FAB) to open cart -->
    <button id="openCartFab" aria-label="Abrir carrinho" class="fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-full shadow-lg flex items-center justify-center z-50 transition-transform duration-200 hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
        <span id="cartItemCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center transform scale-0 transition-transform duration-200">0</span>
    </button>
    
    <!-- Modal de Confirmação -->
    <div id="toast" class="fixed bottom-5 right-5 bg-blue-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all duration-300 z-[101]">
        <p>Item adicionado ao carrinho!</p>
    </div>

    <script>
    // --- INTEGRAÇÃO N8N ---
    const productsData = [
        {
            id: 'prod001',
            name: 'Dipirona Sódica 500mg',
            description: 'Caixa com 10 comprimidos. Analgésico e antitérmico.',
            price: 8.50,
            imageUrl: 'https://placehold.co/300x300/e0f2fe/0284c7?text=Dipirona'
        },
        {
            id: 'prod002',
            name: 'Paracetamol 750mg',
            description: 'Caixa com 20 comprimidos. Indicado para dor e febre.',
            price: 12.75,
            imageUrl: 'https://placehold.co/300x300/e0f2fe/0284c7?text=Paracetamol'
        },
        {
            id: 'prod003',
            name: 'Vitamina C Efervescente',
            description: 'Tubo com 10 comprimidos. Sabor laranja.',
            price: 15.00,
            imageUrl: 'https://placehold.co/300x300/e0f2fe/0284c7?text=Vitamina+C'
        },
        {
            id: 'prod004',
            name: 'Soro Fisiológico 0,9%',
            description: 'Frasco com 500ml. Uso nasal, inalações e limpeza.',
            price: 6.20,
            imageUrl: 'https://placehold.co/300x300/e0f2fe/0284c7?text=Soro'
        },
        {
            id: 'prod005',
            name: 'Álcool em Gel 70%',
            description: 'Frasco com 250ml. Antisséptico para as mãos.',
            price: 9.90,
            imageUrl: 'https://placehold.co/300x300/e0f2fe/0284c7?text=Álcool+Gel'
        },
        {
            id: 'prod006',
            name: 'Curativos Adesivos',
            description: 'Caixa com 35 unidades. Discretos e resistentes.',
            price: 7.80,
            imageUrl: 'https://placehold.co/300x300/e0f2fe/0284c7?text=Curativos'
        }
    ];

    let cart = {};

    const productListContainer = document.getElementById('productList');
    const cartItemsContainer = document.getElementById('cartItems');
    const cartItemsList = document.getElementById('cartItemsList');
    const cartTotalElement = document.getElementById('cartTotal');
    const emptyCartMessage = document.getElementById('emptyCartMessage');
    const openDeliveryModalBtn = document.getElementById('openDeliveryModalBtn');
    const toastElement = document.getElementById('toast');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartOverlay = document.getElementById('cartOverlay');
    const openCartFab = document.getElementById('openCartFab');
    const closeCartBtn = document.getElementById('closeCartBtn');
    const cartItemCount = document.getElementById('cartItemCount');
    const deliveryModal = document.getElementById('deliveryModal');
    const deliveryForm = document.getElementById('deliveryForm');
    const cancelDeliveryBtn = document.getElementById('cancelDeliveryBtn');
    const cepInput = document.getElementById('customerCep');
    const cepLoading = document.getElementById('cep-loading');
    let sessionId = null;
    let sessionPhone = null;
    
    // Configuração da API - ajuste para produção
    const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000' 
        : window.location.origin; // Usa o mesmo domínio com proxy reverso

    function formatCurrency(value) {
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function debounce(fn, delay = 200) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    }

    function renderProducts() {
        if (!productListContainer) return;
        const query = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
        const filtered = productsData.filter(p => {
            const tName = p.name.toLowerCase();
            const tDesc = p.description.toLowerCase();
            return tName.includes(query) || tDesc.includes(query);
        });
        productListContainer.innerHTML = filtered.map(product => `
            <div class="product-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl hover:-translate-y-1 flex flex-col">
                <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover" loading="lazy">
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="text-lg font-bold">${product.name}</h3>
                    <p class="text-slate-600 text-sm mt-1 flex-grow">${product.description}</p>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-xl font-bold text-blue-600">${formatCurrency(product.price)}</span>
                        <button class="add-to-cart-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors" data-id="${product.id}" aria-label="Adicionar ${product.name} ao carrinho">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function addToCart(productId) {
        if (cart[productId]) {
            cart[productId].quantity++;
        } else {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                cart[productId] = { ...product, quantity: 1 };
            }
        }
        saveCart();
        showToast();
        renderCart();
    }
    
    function showToast() {
        toastElement.classList.remove('opacity-0', 'translate-y-10');
        setTimeout(() => {
            toastElement.classList.add('opacity-0', 'translate-y-10');
        }, 2000);
    }

    function updateQuantity(productId, change) {
        if (cart[productId]) {
            cart[productId].quantity += change;
            if (cart[productId].quantity <= 0) {
                delete cart[productId];
            }
            saveCart();
            renderCart();
        }
    }

    function saveCart() {
        try {
            localStorage.setItem('cart', JSON.stringify(cart));
        } catch (e) {}
    }
    
    function toggleCart() {
        cartDrawer.classList.toggle('translate-x-full');
        if (cartDrawer.classList.contains('translate-x-full')) {
            cartOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        } else {
            cartOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function renderCart() {
        if (!cartItemsContainer || !cartItemsList) return;
        const cartKeys = Object.keys(cart);
        let total = 0;
        let totalItems = 0;
        const emptyMsgEl = document.getElementById('emptyCartMessage');

        if (cartKeys.length === 0) {
            emptyMsgEl && emptyMsgEl.classList.remove('hidden');
            cartItemsList.innerHTML = '';
            openDeliveryModalBtn.disabled = true;
        } else {
            emptyMsgEl && emptyMsgEl.classList.add('hidden');
            cartItemsList.innerHTML = '';
            openDeliveryModalBtn.disabled = false;
        }
        
        cartKeys.forEach(key => {
            const item = cart[key];
            total += item.price * item.quantity;
            totalItems += item.quantity;

            const cartItemHTML = `
                <div class="cart-item flex justify-between items-center">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-slate-500">${formatCurrency(item.price)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="decrease-qty-btn w-8 h-8 flex items-center justify-center bg-slate-200 rounded-full font-bold hover:bg-slate-300 transition-colors" data-id="${item.id}">-</button>
                        <span class="w-8 text-center font-medium">${item.quantity}</span>
                        <button class="increase-qty-btn w-8 h-8 flex items-center justify-center bg-slate-200 rounded-full font-bold hover:bg-slate-300 transition-colors" data-id="${item.id}">+</button>
                        <button class="remove-item-btn w-8 h-8 flex items-center justify-center rounded-full text-red-600 hover:bg-red-100" data-id="${item.id}" title="Remover">×</button>
                    </div>
                </div>
            `;
            cartItemsList.innerHTML += cartItemHTML;
        });

        cartTotalElement.textContent = formatCurrency(total);

        if (cartItemCount) {
            if (totalItems > 0) {
                cartItemCount.textContent = String(totalItems);
                cartItemCount.classList.remove('scale-0');
            } else {
                cartItemCount.textContent = '0';
                cartItemCount.classList.add('scale-0');
            }
        }
    }
    
    function sendWhatsAppMessage(deliveryDetails) {
        const phoneNumber = sessionPhone || '5511999998888'; 
        if (Object.keys(cart).length === 0) return;

        let message = 'Olá! Gostaria de fazer o seguinte pedido:\n\n';
        let total = 0;

        // Adiciona produtos à mensagem
        Object.values(cart).forEach(item => {
            message += `*${item.name}*\n`;
            message += `Quantidade: ${item.quantity}\n`;
            message += `Subtotal: ${formatCurrency(item.price * item.quantity)}\n\n`;
            total += item.price * item.quantity;
        });

        message += `*Total do Pedido: ${formatCurrency(total)}*\n\n`;
        
        // Adiciona forma de pagamento à mensagem
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (selectedPaymentMethod) {
            const paymentMethodText = selectedPaymentMethod.nextElementSibling.textContent.trim();
            message += `*Forma de Pagamento:* ${paymentMethodText}\n\n`;
        }
        
        // Adiciona dados de entrega à mensagem
        message += `*-- Dados de Entrega --*\n`;
        message += `*Nome:* ${deliveryDetails.name}\n`;
        message += `*Endereço:* ${deliveryDetails.street}, Nº ${deliveryDetails.number}\n`;
        if (deliveryDetails.complement) {
            message += `*Complemento:* ${deliveryDetails.complement}\n`;
        }
        message += `*Bairro:* ${deliveryDetails.neighborhood}\n`;
        message += `*Cidade/UF:* ${deliveryDetails.city}/${deliveryDetails.state}\n`;
        message += `*CEP:* ${deliveryDetails.cep}`;


        const encodedMessage = encodeURIComponent(message);
        const url = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        window.open(url, '_blank');
    }

    function openDeliveryModal() {
        deliveryModal.classList.remove('hidden');
        deliveryModal.classList.add('flex');
        const nameEl = document.getElementById('customerName');
        if (nameEl) nameEl.focus();
    }

    function closeDeliveryModal() {
        deliveryModal.classList.add('hidden');
        deliveryModal.classList.remove('flex');
    }

    function clearAddressForm() {
        document.getElementById('customerStreet').value = '';
        document.getElementById('customerNeighborhood').value = '';
        document.getElementById('customerCity').value = '';
        document.getElementById('customerState').value = '';
    }

    function getSessionIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('sessao_id');
    }

    async function loadSession() {
        sessionId = getSessionIdFromURL();
        if (!sessionId) return;
        try {
            const res = await fetch(`${API_BASE}/api/produtos/${sessionId}`);
            if (!res.ok) return;
            const data = await res.json();
            sessionPhone = data.cliente_telefone || null;
            const status = data.status;
            if (status === 'expirada' || status === 'finalizada') {
                openDeliveryModalBtn.disabled = true;
            }
            // Substitui os produtos locais pelos da sessão
            productsData.splice(0, productsData.length);
            data.produtos.forEach(p => {
                productsData.push({
                    id: String(p.id),
                    name: p.descricao,
                    description: p.apresentacao || p.categoria || p.descricao,
                    price: Number(p.preco),
                    imageUrl: p.imagem_url || 'https://placehold.co/300x300/e0f2fe/0284c7?text=Produto'
                });
            });
        } catch (e) {
            console.error('Falha ao carregar sessão', e);
        }
    }

    async function postSelection(deliveryDetails = null) {
        if (!sessionId) return;
        
        // Preparar dados dos produtos selecionados
        const produtos_selecionados = Object.values(cart).map(item => ({
            produto_id: Number(item.id.replace(/\D/g, '')) || Number(item.id),
            quantidade: item.quantity
        }));

        // Obter forma de pagamento selecionada
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        const formaPagamento = selectedPaymentMethod ? selectedPaymentMethod.value : null;

        try {
            // 1. Registrar seleção no backend (mantém funcionalidade existente)
            const res = await fetch(`${API_BASE}/api/produtos/${sessionId}/selecionar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    produtos_selecionados,
                    cliente_telefone: sessionPhone || undefined,
                    forma_pagamento: formaPagamento
                })
            });
            if (!res.ok) {
                console.warn('Falha ao registrar seleção no backend');
            }

            // 2. Enviar dados completos para webhook do n8n (se tiver dados de entrega)
            if (deliveryDetails) {
                await sendWebhookToN8n(deliveryDetails, formaPagamento);
            }
        } catch (e) {
            console.warn('Erro ao registrar seleção no backend', e);
        }
    }

    async function sendWebhookToN8n(deliveryDetails, formaPagamento) {
        try {
            // Calcular total do pedido
            let total = 0;
            const produtos = Object.values(cart).map(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                return {
                    id: item.id,
                    nome: item.name,
                    descricao: item.description,
                    preco_unitario: item.price,
                    quantidade: item.quantity,
                    subtotal: subtotal
                };
            });

            // Estruturar payload JSON completo
            const webhookPayload = {
                pedido: {
                    sessao_id: sessionId,
                    data_pedido: new Date().toISOString(),
                    status: "novo",
                    valor_total: total
                },
                cliente: {
                    nome: deliveryDetails.name,
                    telefone: sessionPhone || null
                },
                entrega: {
                    cep: deliveryDetails.cep,
                    endereco: deliveryDetails.street,
                    numero: deliveryDetails.number,
                    complemento: deliveryDetails.complement || null,
                    bairro: deliveryDetails.neighborhood,
                    cidade: deliveryDetails.city,
                    estado: deliveryDetails.state
                },
                pagamento: {
                    forma_pagamento: formaPagamento,
                    valor_total: total
                },
                produtos: produtos
            };

            console.log('📤 Enviando webhook para n8n:', webhookPayload);

            // Enviar para webhook do n8n
            const webhookResponse = await fetch('https://integra.devsible.com.br/webhook-test/env_pedido', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookPayload)
            });

            const responseText = await webhookResponse.text();
            console.log('📥 Resposta do webhook:', {
                status: webhookResponse.status,
                statusText: webhookResponse.statusText,
                response: responseText
            });

            if (webhookResponse.ok) {
                console.log('✅ Pedido enviado com sucesso para n8n');
                alert('✅ Pedido enviado com sucesso para o sistema!');
            } else {
                console.warn('⚠️ Falha ao enviar pedido para n8n:', webhookResponse.status, responseText);
                alert('⚠️ Webhook n8n não está ativo. Pedido salvo localmente.');
            }
        } catch (error) {
            console.error('❌ Erro ao enviar webhook para n8n:', error);
            alert('❌ Erro de conexão. Pedido salvo localmente.');
        }
    }

    // --- Listeners de Eventos ---

    productListContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('add-to-cart-btn')) {
            const productId = event.target.getAttribute('data-id');
            addToCart(productId);
        }
    });
    
    cartItemsContainer.addEventListener('click', (event) => {
        const target = event.target;
        const productId = target.getAttribute('data-id');
        if (!productId) return;

        if (target.classList.contains('increase-qty-btn')) {
            updateQuantity(productId, 1);
        } else if (target.classList.contains('decrease-qty-btn')) {
            updateQuantity(productId, -1);
        } else if (target.classList.contains('remove-item-btn')) {
            delete cart[productId];
            saveCart();
            renderCart();
        }
    });
    
    openDeliveryModalBtn.addEventListener('click', openDeliveryModal);
    cancelDeliveryBtn.addEventListener('click', closeDeliveryModal);
    
    deliveryForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const deliveryDetails = {
            name: document.getElementById('customerName').value.trim(),
            cep: document.getElementById('customerCep').value.trim(),
            street: document.getElementById('customerStreet').value.trim(),
            number: document.getElementById('customerNumber').value.trim(),
            complement: document.getElementById('customerComplement').value.trim(),
            neighborhood: document.getElementById('customerNeighborhood').value.trim(),
            city: document.getElementById('customerCity').value.trim(),
            state: document.getElementById('customerState').value.trim()
        };
        
        // Validações adicionais: CEP (8 dígitos) e Número (apenas dígitos)
        const cepDigits = deliveryDetails.cep.replace(/\D/g, '');
        if (cepDigits.length !== 8) {
            alert('CEP deve ter 8 dígitos.');
            return;
        }
        if (!/^\d+$/.test(deliveryDetails.number)) {
            alert('Número deve conter apenas dígitos.');
            return;
        }

        // Validação da forma de pagamento
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!selectedPaymentMethod) {
            alert('Por favor, selecione uma forma de pagamento.');
            return;
        }

        if (deliveryDetails.name && deliveryDetails.street && deliveryDetails.number) {
            await postSelection(deliveryDetails);
            sendWhatsAppMessage(deliveryDetails);
            closeDeliveryModal();
            deliveryForm.reset();
        }
    });

    cepInput.addEventListener('input', (e) => {
        let value = e.target.value;
        value = value.replace(/\D/g, "");
        value = value.replace(/^(\d{5})(\d)/, "$1-$2");
        e.target.value = value;
    });

    cepInput.addEventListener('blur', async (e) => {
        const cep = e.target.value.replace(/\D/g, '');
        if (cep.length !== 8) {
            clearAddressForm();
            return;
        }

        cepLoading.classList.remove('hidden');
        clearAddressForm();

        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();

            if (data.erro) {
                alert('CEP não encontrado.');
                return;
            }

            document.getElementById('customerStreet').value = data.logradouro;
            document.getElementById('customerNeighborhood').value = data.bairro;
            document.getElementById('customerCity').value = data.localidade;
            document.getElementById('customerState').value = data.uf;
            document.getElementById('customerNumber').focus();

        } catch (error) {
            alert('Não foi possível buscar o CEP. Tente novamente.');
        } finally {
            cepLoading.classList.add('hidden');
        }
    });

    openCartFab.addEventListener('click', toggleCart);
    closeCartBtn.addEventListener('click', toggleCart);
    cartOverlay.addEventListener('click', toggleCart);
    
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !cartDrawer.classList.contains('translate-x-full')) {
            toggleCart();
        }
        if (event.key === 'Escape' && !deliveryModal.classList.contains('hidden')) {
            closeDeliveryModal();
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        // Carregar carrinho salvo
        try {
            const stored = localStorage.getItem('cart');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed && typeof parsed === 'object') {
                    cart = parsed;
                }
            }
        } catch (e) {}

        await loadSession();
        renderProducts();
        renderCart();

        const searchInputEl = document.getElementById('searchInput');
        if (searchInputEl) {
            const handleSearch = debounce(renderProducts, 200);
            searchInputEl.addEventListener('input', handleSearch);
        }
    });
    </script>
</body>
</html>

