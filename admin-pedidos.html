<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pedidos | GestÃ£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        emerald: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .dark body {
            background-color: #0f172a;
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.95);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="text-slate-800 dark:text-slate-100 transition-colors duration-200">

    <!-- Notification -->
    <div id="toast" class="fixed top-4 right-4 hidden z-50 animate-slide-in">
        <div
            class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-lg px-4 py-3 flex items-center gap-3">
            <div id="toastIcon" class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"></div>
            <div>
                <h4 id="toastTitle" class="text-sm font-bold text-slate-900 dark:text-white"></h4>
                <p id="toastMessage" class="text-xs text-slate-500 dark:text-slate-400"></p>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 glass border-b border-slate-200 dark:border-slate-800 h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-emerald-500/30">
                    <i class="fa-solid fa-receipt"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight">Admin Pedidos</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">GestÃ£o em Tempo Real</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div
                    class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-green-500/10 text-green-600 dark:text-green-400 rounded-full text-xs font-semibold border border-green-500/20">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    ONLINE
                </div>
                <a href="/catalogo.html" target="_blank"
                    class="p-2 text-slate-500 hover:text-emerald-600 transition-colors" title="Ver CatÃ¡logo">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                </a>
                <a href="/admin-banners.html" class="p-2 text-slate-500 hover:text-emerald-600 transition-colors"
                    title="Banners">
                    <i class="fa-solid fa-layer-group"></i>
                </a>
                <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:text-yellow-500 transition-colors">
                    <i class="fa-solid fa-sun dark:hidden"></i>
                    <i class="fa-solid fa-moon hidden dark:block"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 max-w-7xl mx-auto">

        <!-- Stats Grid -->
        <div id="statsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Pendentes -->
            <div
                class="bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400 group-hover:scale-110 transition-transform">
                        <i class="fa-regular fa-clock text-lg"></i>
                    </div>
                    <span class="text-2xl font-bold text-slate-800 dark:text-white" id="statPendente">0</span>
                </div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Pendentes</p>
            </div>

            <!-- Confirmados -->
            <div
                class="bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-check-double text-lg"></i>
                    </div>
                    <span class="text-2xl font-bold text-slate-800 dark:text-white" id="statConfirmado">0</span>
                </div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Confirmados</p>
            </div>

            <!-- Em Entrega -->
            <div
                class="bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-motorcycle text-lg"></i>
                    </div>
                    <span class="text-2xl font-bold text-slate-800 dark:text-white" id="statEnviado">0</span>
                </div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Em Entrega</p>
            </div>

            <!-- Entregues -->
            <div
                class="bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-box-open text-lg"></i>
                    </div>
                    <span class="text-2xl font-bold text-slate-800 dark:text-white" id="statEntregue">0</span>
                </div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Entregues</p>
            </div>
        </div>

        <!-- Filters -->
        <div id="filtersSection" class="mb-8 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0 md:pb-0">
            <div class="flex gap-2 min-w-max">
                <button
                    class="filter-chip active px-4 py-2 rounded-xl text-sm font-semibold border border-transparent bg-slate-800 text-white shadow-lg shadow-slate-500/20 transition-all"
                    data-status="todos">
                    Todos
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    data-status="pendente">
                    Pendentes
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    data-status="confirmado">
                    Confirmados
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    data-status="preparando">
                    Preparando
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    data-status="enviado">
                    Em Entrega
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    data-status="entregue">
                    Entregues
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    data-status="cancelado">
                    Cancelados
                </button>
            </div>
        </div>

        <!-- Specific Order Banner -->
        <div id="specificOrderBanner"
            class="hidden bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-2xl p-4 mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400">
                    <i class="fa-solid fa-filter"></i>
                </div>
                <div>
                    <p class="font-bold text-blue-900 dark:text-blue-100">Filtrando Pedido</p>
                    <p class="text-sm text-blue-700 dark:text-blue-300">Exibindo apenas #<span
                            id="specificOrderNumber"></span></p>
                </div>
            </div>
            <a href="admin-pedidos.html" class="text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline">
                Limpar Filtro
            </a>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="grid grid-cols-1 gap-6">
            <!-- Orders will be injected here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
            <div
                class="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 text-slate-400">
                <i class="fa-solid fa-clipboard-list text-4xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Nenhum pedido encontrado</h3>
            <p class="text-slate-500 dark:text-slate-400 max-w-xs mx-auto">NÃ£o hÃ¡ pedidos com o status selecionado no
                momento.</p>
        </div>

    </main>

    <script>
        // --- Logic ---
        let orders = [];
        let initialRenderDone = false;
        let lastOrdersSignature = '';
        let isFetching = false;
        let currentFilter = 'todos';

        // Mock Data Fallback
        const mockOrders = [
            {
                id: 71,
                order_number: 'PED-071',
                customer: { name: 'JoÃ£o Silva', phone: '11987654321', address: 'Rua das Flores, 123' },
                items: [{ name: 'Dipirona 500mg', quantity: 2, price: 8.50 }, { name: 'Vitamina C', quantity: 1, price: 15.00 }],
                total: 32.00,
                status: 'pendente',
                createdAt: new Date(Date.now() - 5 * 60000).toISOString(),
                paymentMethod: 'pix'
            },
            {
                id: 70,
                order_number: 'PED-070',
                customer: { name: 'Maria Santos', phone: '11912345678', address: 'Av. Principal, 456' },
                items: [{ name: 'Paracetamol', quantity: 1, price: 12.00 }],
                total: 12.00,
                status: 'confirmado',
                createdAt: new Date(Date.now() - 15 * 60000).toISOString(),
                paymentMethod: 'cash',
                cashReceived: 20,
                cashChange: 8
            }
        ];

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }

            fetchOrders();
            setInterval(fetchOrders, 10000); // Polling every 10s

            document.querySelectorAll('.filter-chip').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(b => {
                        b.classList.remove('active', 'bg-slate-800', 'text-white', 'shadow-lg');
                        b.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300', 'border-slate-200', 'dark:border-slate-700');
                    });
                    btn.classList.remove('bg-white', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300', 'border-slate-200', 'dark:border-slate-700');
                    btn.classList.add('active', 'bg-slate-800', 'dark:bg-emerald-600', 'text-white', 'shadow-lg');

                    currentFilter = btn.getAttribute('data-status');
                    renderOrders();
                });
            });
        });

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // --- Utils ---
        const showToast = (title, msg, type = 'success') => {
            const el = document.getElementById('toast');
            const iconEl = document.getElementById('toastIcon');

            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = msg;

            el.classList.remove('hidden');

            if (type === 'success') {
                iconEl.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400';
                iconEl.innerHTML = '<i class="fa-solid fa-check"></i>';
            } else {
                iconEl.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400';
                iconEl.innerHTML = '<i class="fa-solid fa-xmark"></i>';
            }

            setTimeout(() => el.classList.add('hidden'), 3000);
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

        const getTimeAgo = (dateStr) => {
            const diff = Date.now() - new Date(dateStr).getTime();
            const min = Math.floor(diff / 60000);
            if (min < 1) return 'Agora mesmo';
            if (min < 60) return `${min} min atrÃ¡s`;
            const h = Math.floor(min / 60);
            if (h < 24) return `${h}h atrÃ¡s`;
            return new Date(dateStr).toLocaleDateString('pt-BR');
        };

        const getPaymentLabel = (method) => {
            const map = { 'pix': 'PIX', 'card': 'CartÃ£o', 'cash': 'Dinheiro' };
            return map[method] || method || 'NÃ£o inf.';
        };

        // --- API ---
        const getApiBase = () => {
            const port = window.location.port;
            return (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
        };

        async function fetchOrders() {
            if (isFetching) return;
            isFetching = true;
            try {
                const API_BASE = getApiBase();
                const res = await fetch(`${API_BASE}/api/orders`);
                if (res.ok) {
                    const data = await res.json();
                    orders = data.orders || [];
                } else {
                    console.warn('API Error, using mock');
                    orders = mockOrders;
                }
            } catch (e) {
                console.error('Fetch Error', e);
                orders = mockOrders;
            } finally {
                const sig = JSON.stringify(orders.map(o => `${o.id}-${o.status}-${o.delivery_status}`));
                if (sig !== lastOrdersSignature) {
                    renderOrders();
                    updateStats();
                    lastOrdersSignature = sig;
                } else {
                    updateTimeAgo();
                }
                isFetching = false;
            }
        }

        // --- Render ---
        function renderOrders() {
            const listEl = document.getElementById('ordersList');
            const emptyEl = document.getElementById('emptyState');
            const urlParams = new URLSearchParams(window.location.search);
            const specificId = urlParams.get('pedido');

            let filtered = orders;

            if (specificId) {
                filtered = orders.filter(o => String(o.id) === specificId);
                document.getElementById('specificOrderBanner').classList.remove('hidden');
                document.getElementById('specificOrderNumber').textContent = specificId;
                document.getElementById('filtersSection').classList.add('hidden');
                document.getElementById('statsGrid').classList.add('hidden');
            } else {
                document.getElementById('specificOrderBanner').classList.add('hidden');
                document.getElementById('filtersSection').classList.remove('hidden');
                document.getElementById('statsGrid').classList.remove('hidden');
                if (currentFilter !== 'todos') {
                    filtered = orders.filter(o => o.status === currentFilter);
                }
            }

            if (filtered.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            listEl.innerHTML = filtered.map(o => createCardHTML(o)).join('');
        }

        function createCardHTML(order) {
            const statusConfig = {
                pendente: { label: 'Pendente', class: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800', icon: 'fa-clock' },
                confirmado: { label: 'Confirmado', class: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800', icon: 'fa-check-double' },
                preparando: { label: 'Preparando', class: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800', icon: 'fa-box' },
                enviado: { label: 'Em Entrega', class: 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800', icon: 'fa-motorcycle' },
                entregue: { label: 'Entregue', class: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800', icon: 'fa-check' },
                cancelado: { label: 'Cancelado', class: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800', icon: 'fa-xmark' }
            };
            const st = statusConfig[order.status] || statusConfig.pendente;
            const timeAgo = getTimeAgo(order.createdAt);

            return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-all" data-id="${order.id}">
                    <div class="flex flex-col md:flex-row md:items-start justify-between gap-4 mb-6">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">#${order.order_number || order.id}</h3>
                                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border ${st.class} flex items-center gap-2">
                                    <i class="fa-solid ${st.icon}"></i>
                                    ${st.label}
                                </span>
                            </div>
                            <p class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2">
                                <i class="fa-regular fa-clock"></i>
                                <span class="time-ago">${timeAgo}</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-3xl font-bold text-slate-900 dark:text-white">${formatCurrency(order.total)}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold tracking-wider mt-1">
                                ${getPaymentLabel(order.paymentMethod)}
                            </p>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- Customer -->
                        <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-100 dark:border-slate-700/50">
                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-400 shrink-0">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-800 dark:text-slate-200 text-sm mb-1">${order.customer.name}</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-2 font-mono">${order.customer.phone}</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-500 leading-relaxed">
                                        <i class="fa-solid fa-location-dot mr-1"></i>
                                        ${order.customer.address}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Items -->
                        <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-100 dark:border-slate-700/50">
                            <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-3 tracking-wider">Itens do Pedido</h4>
                            <ul class="space-y-2">
                                ${order.items.map(i => `
                                    <li class="flex justify-between text-sm items-center">
                                        <span class="text-slate-600 dark:text-slate-300">
                                            <span class="font-bold text-slate-900 dark:text-white mr-1">${i.quantity}x</span> 
                                            ${i.name}
                                        </span>
                                        <span class="text-slate-500 dark:text-slate-400 font-medium">${formatCurrency(i.price * i.quantity)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                        <div class="flex-1 min-w-[200px]">
                            ${order.status !== 'pendente' && order.status !== 'cancelado' ? `
                                <div class="relative">
                                    <select onchange="updateDeliveryStatus(${order.id}, this.value)" class="w-full appearance-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-sm rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none block pl-4 pr-10 py-2.5 cursor-pointer transition-all hover:border-emerald-500">
                                        <option value="pending" ${!order.delivery_status || order.delivery_status === 'pending' ? 'selected' : ''}>Entrega Pendente</option>
                                        <option value="preparing" ${order.delivery_status === 'preparing' ? 'selected' : ''}>ðŸ“¦ Preparando</option>
                                        <option value="out_for_delivery" ${order.delivery_status === 'out_for_delivery' ? 'selected' : ''}>ðŸšš Saiu p/ Entrega</option>
                                        <option value="delivered" ${order.delivery_status === 'delivered' ? 'selected' : ''}>ðŸŽ‰ Entregue</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex gap-3">
                            ${order.status === 'pendente' ? `
                                <button onclick="updateStatus(${order.id}, 'confirmado')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-emerald-600/20 transition-all hover:-translate-y-0.5 flex items-center gap-2">
                                    <i class="fa-solid fa-check"></i>
                                    Aceitar
                                </button>
                                <button onclick="updateStatus(${order.id}, 'cancelado')" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 dark:hover:text-red-400 text-slate-600 dark:text-slate-400 px-5 py-2.5 rounded-xl text-sm font-semibold transition-all">
                                    Recusar
                                </button>
                            ` : ''}
                            
                            ${order.status === 'confirmado' ? `
                                <button onclick="updateStatus(${order.id}, 'enviado')" class="bg-purple-600 hover:bg-purple-500 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-purple-600/20 transition-all hover:-translate-y-0.5 flex items-center gap-2">
                                    <i class="fa-solid fa-motorcycle"></i>
                                    Enviar
                                </button>
                            ` : ''}

                            ${order.status === 'enviado' ? `
                                <button onclick="updateStatus(${order.id}, 'entregue')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-emerald-600/20 transition-all hover:-translate-y-0.5 flex items-center gap-2">
                                    <i class="fa-solid fa-check-double"></i>
                                    Confirmar Entrega
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const counts = { pendente: 0, confirmado: 0, enviado: 0, entregue: 0 };
            orders.forEach(o => {
                if (counts[o.status] !== undefined) counts[o.status]++;
            });
            document.getElementById('statPendente').textContent = counts.pendente;
            document.getElementById('statConfirmado').textContent = counts.confirmado;
            document.getElementById('statEnviado').textContent = counts.enviado;
            document.getElementById('statEntregue').textContent = counts.entregue;
        }

        function updateTimeAgo() {
            document.querySelectorAll('.order-card').forEach(card => {
                const id = card.getAttribute('data-id');
                const order = orders.find(o => o.id == id);
                if (order) {
                    const el = card.querySelector('.time-ago');
                    if (el) el.textContent = getTimeAgo(order.createdAt);
                }
            });
        }

        // --- Actions ---
        window.updateStatus = async (id, status) => {
            try {
                const API_BASE = getApiBase();
                const res = await fetch(`${API_BASE}/api/orders/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (res.ok) {
                    showToast('Status Atualizado', `Pedido #${id} movido para ${status}`);
                    fetchOrders();
                } else {
                    showToast('Erro', 'NÃ£o foi possÃ­vel atualizar o status', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Erro de ConexÃ£o', 'Verifique sua internet', 'error');
            }
        };

        window.updateDeliveryStatus = async (id, status) => {
            try {
                const API_BASE = getApiBase();
                const res = await fetch(`${API_BASE}/api/orders/${id}/delivery-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delivery_status: status })
                });
                if (res.ok) {
                    showToast('Entrega Atualizada', 'Status de logÃ­stica alterado');
                    fetchOrders(); // Refresh to ensure sync
                } else {
                    showToast('Erro', 'NÃ£o foi possÃ­vel atualizar a entrega', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Erro de ConexÃ£o', 'Verifique sua internet', 'error');
            }
        };
    </script>
</body>

</html>