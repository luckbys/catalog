<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pedidos - Hakim Farma Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-pendente {
            background-color: #fffbeb;
            color: #b45309;
            border: 1px solid #fcd34d;
        }

        .status-confirmado {
            background-color: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }

        .status-preparando {
            background-color: #eef2ff;
            color: #4338ca;
            border: 1px solid #a5b4fc;
        }

        .status-enviado {
            background-color: #f5f3ff;
            color: #6d28d9;
            border: 1px solid #c4b5fd;
        }

        .status-entregue {
            background-color: #ecfdf5;
            color: #047857;
            border: 1px solid #6ee7b7;
        }

        .status-cancelado {
            background-color: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fca5a5;
        }

        .order-card {
            transition: all 0.2s ease;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .filter-chip {
            transition: all 0.2s;
        }

        .filter-chip.active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen text-gray-800">

    <!-- Notification -->
    <div id="toast"
        class="fixed top-4 right-4 hidden bg-white border-2 border-emerald-200 text-emerald-700 rounded-xl shadow-lg px-4 py-3 z-50 animate-slide-in">
        <div class="flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"></path>
            </svg>
            <span id="toastText" class="text-sm font-semibold">Status atualizado!</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-gray-100">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl overflow-hidden shadow-sm bg-white border border-gray-100 p-1">
                        <img src="public/logo.png" alt="Logo" class="w-full h-full object-contain" />
                    </div>
                    <main class="container mx-auto px-4 py-6 max-w-7xl">

                        <!-- Stats Grid -->
                        <div id="statsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div
                                class="bg-white rounded-2xl p-4 shadow-sm border border-orange-100 hover:border-orange-200 transition-colors group">
                                <div class="flex items-center justify-between mb-2">
                                    <div
                                        class="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center text-orange-500 group-hover:scale-110 transition-transform">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-bold text-gray-800" id="statPendente">0</span>
                                </div>
                                <p class="text-sm font-medium text-gray-500">Pendentes</p>
                            </div>

                            <div
                                class="bg-white rounded-2xl p-4 shadow-sm border border-blue-100 hover:border-blue-200 transition-colors group">
                                <div class="flex items-center justify-between mb-2">
                                    <div
                                        class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-bold text-gray-800" id="statConfirmado">0</span>
                                </div>
                                <p class="text-sm font-medium text-gray-500">Confirmados</p>
                            </div>

                            <div
                                class="bg-white rounded-2xl p-4 shadow-sm border border-purple-100 hover:border-purple-200 transition-colors group">
                                <div class="flex items-center justify-between mb-2">
                                    <div
                                        class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center text-purple-500 group-hover:scale-110 transition-transform">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <rect x="1" y="3" width="15" height="13"></rect>
                                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-bold text-gray-800" id="statEnviado">0</span>
                                </div>
                                <p class="text-sm font-medium text-gray-500">Em Entrega</p>
                            </div>

                            <div
                                class="bg-white rounded-2xl p-4 shadow-sm border border-emerald-100 hover:border-emerald-200 transition-colors group">
                                <div class="flex items-center justify-between mb-2">
                                    <div
                                        class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-500 group-hover:scale-110 transition-transform">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-bold text-gray-800" id="statEntregue">0</span>
                                </div>
                                <p class="text-sm font-medium text-gray-500">Entregues</p>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div id="filtersSection" class="mb-6 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0 md:pb-0">
                            <div class="flex gap-2 min-w-max">
                                <button
                                    class="filter-chip active px-4 py-2 rounded-xl text-sm font-semibold border border-transparent bg-white shadow-sm text-gray-600 hover:bg-gray-50"
                                    data-status="todos">
                                    Todos
                                </button>
                                <button
                                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                                    data-status="pendente">
                                    Pendentes
                                </button>
                                <button
                                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                                    data-status="confirmado">
                                    Confirmados
                                </button>
                                <button
                                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                                    data-status="preparando">
                                    Preparando
                                </button>
                                <button
                                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                                    data-status="enviado">
                                    Em Entrega
                                </button>
                                <button
                                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                                    data-status="entregue">
                                    Entregues
                                </button>
                                <button
                                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                                    data-status="cancelado">
                                    Cancelados
                                </button>
                            </div>
                        </div>

                        <!-- Specific Order Banner -->
                        <div id="specificOrderBanner"
                            class="hidden bg-blue-50 border border-blue-100 rounded-2xl p-4 mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-bold text-blue-900">Filtrando Pedido</p>
                                    <p class="text-sm text-blue-700">Exibindo apenas #<span
                                            id="specificOrderNumber"></span></p>
                                </div>
                            </div>
                            <a href="admin-pedidos.html"
                                class="text-sm font-semibold text-blue-600 hover:text-blue-800 hover:underline">
                                Limpar Filtro
                            </a>
                        </div>

                        <!-- Orders List -->
                        <div id="ordersList" class="grid grid-cols-1 gap-4">
                            <!-- Orders will be injected here -->
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
                            <div
                                class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1.5">
                                    <path d="M21 8v13H3V8"></path>
                                    <path d="M1 3h22v5H1z"></path>
                                    <path d="M10 12h4"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhum pedido encontrado</h3>
                            <p class="text-xs text-gray-500 font-medium">GestÃ£o em Tempo Real</p>
                        </div>
                </div>

                <div class="flex items-center gap-2">
                    <div
                        class="hidden md:flex items-center gap-2 bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100 mr-2">
                        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                        <span class="text-xs font-bold text-emerald-700 uppercase tracking-wide">Online</span>
                    </div>

                    <a href="catalogo.html"
                        class="hidden md:inline-flex items-center justify-center h-9 px-3 rounded-lg text-sm font-medium text-gray-600 hover:text-emerald-600 hover:bg-gray-50 transition-colors"
                        title="Ver CatÃ¡logo">
                        CatÃ¡logo
                    </a>

                    <div class="h-6 w-px bg-gray-200 mx-1 hidden md:block"></div>

                    <a href="admin-config.html"
                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 bg-white hover:border-emerald-500 hover:text-emerald-600 transition-all shadow-sm"
                        title="ConfiguraÃ§Ãµes">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                            </path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </a>
                    <a href="admin-instancias.html"
                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 bg-white hover:border-purple-500 hover:text-purple-600 transition-all shadow-sm"
                        title="InstÃ¢ncias">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                            <line x1="6" y1="6" x2="6.01" y2="6"></line>
                            <line x1="6" y1="18" x2="6.01" y2="18"></line>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-7xl">

        <!-- Stats Grid -->
        <div id="statsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div
                class="bg-white rounded-2xl p-4 shadow-sm border border-orange-100 hover:border-orange-200 transition-colors group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center text-orange-500 group-hover:scale-110 transition-transform">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800" id="statPendente">0</span>
                </div>
                <p class="text-sm font-medium text-gray-500">Pendentes</p>
            </div>

            <div
                class="bg-white rounded-2xl p-4 shadow-sm border border-blue-100 hover:border-blue-200 transition-colors group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800" id="statConfirmado">0</span>
                </div>
                <p class="text-sm font-medium text-gray-500">Confirmados</p>
            </div>

            <div
                class="bg-white rounded-2xl p-4 shadow-sm border border-purple-100 hover:border-purple-200 transition-colors group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center text-purple-500 group-hover:scale-110 transition-transform">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800" id="statEnviado">0</span>
                </div>
                <p class="text-sm font-medium text-gray-500">Em Entrega</p>
            </div>

            <div
                class="bg-white rounded-2xl p-4 shadow-sm border border-emerald-100 hover:border-emerald-200 transition-colors group">
                <div class="flex items-center justify-between mb-2">
                    <div
                        class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-500 group-hover:scale-110 transition-transform">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800" id="statEntregue">0</span>
                </div>
                <p class="text-sm font-medium text-gray-500">Entregues</p>
            </div>
        </div>

        <!-- Filters -->
        <div id="filtersSection" class="mb-6 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0 md:pb-0">
            <div class="flex gap-2 min-w-max">
                <button
                    class="filter-chip active px-4 py-2 rounded-xl text-sm font-semibold border border-transparent bg-white shadow-sm text-gray-600 hover:bg-gray-50"
                    data-status="todos">
                    Todos
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                    data-status="pendente">
                    Pendentes
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                    data-status="confirmado">
                    Confirmados
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                    data-status="preparando">
                    Preparando
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                    data-status="enviado">
                    Em Entrega
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                    data-status="entregue">
                    Entregues
                </button>
                <button
                    class="filter-chip px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 bg-white shadow-sm text-gray-600 hover:bg-gray-50 hover:border-gray-300"
                    data-status="cancelado">
                    Cancelados
                </button>
            </div>
        </div>

        <!-- Specific Order Banner -->
        <div id="specificOrderBanner"
            class="hidden bg-blue-50 border border-blue-100 rounded-2xl p-4 mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <div>
                    <p class="font-bold text-blue-900">Filtrando Pedido</p>
                    <p class="text-sm text-blue-700">Exibindo apenas #<span id="specificOrderNumber"></span></p>
                </div>
            </div>
            <a href="admin-pedidos.html"
                class="text-sm font-semibold text-blue-600 hover:text-blue-800 hover:underline">
                Limpar Filtro
            </a>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="grid grid-cols-1 gap-4">
            <!-- Orders will be injected here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 8v13H3V8"></path>
                    <path d="M1 3h22v5H1z"></path>
                    <path d="M10 12h4"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhum pedido encontrado</h3>
            <p class="text-gray-500 max-w-xs mx-auto">NÃ£o hÃ¡ pedidos com o status selecionado no momento.</p>
        </div>

    </main>

    <script>
        // --- Logic ---
        let orders = [];
        let initialRenderDone = false;
        let lastOrdersSignature = '';
        let isFetching = false;
        let currentFilter = 'todos';

        // Mock Data Fallback
        const mockOrders = [
            {
                id: 71,
                order_number: 'PED-071',
                customer: { name: 'JoÃ£o Silva', phone: '11987654321', address: 'Rua das Flores, 123' },
                items: [{ name: 'Dipirona 500mg', quantity: 2, price: 8.50 }, { name: 'Vitamina C', quantity: 1, price: 15.00 }],
                total: 32.00,
                status: 'pendente',
                createdAt: new Date(Date.now() - 5 * 60000).toISOString(),
                paymentMethod: 'pix'
            },
            {
                id: 70,
                order_number: 'PED-070',
                customer: { name: 'Maria Santos', phone: '11912345678', address: 'Av. Principal, 456' },
                items: [{ name: 'Paracetamol', quantity: 1, price: 12.00 }],
                total: 12.00,
                status: 'confirmado',
                createdAt: new Date(Date.now() - 15 * 60000).toISOString(),
                paymentMethod: 'cash',
                cashReceived: 20,
                cashChange: 8
            }
        ];

        // --- Utils ---
        const showToast = (msg, ok = true) => {
            const el = document.getElementById('toast');
            const txt = document.getElementById('toastText');
            const icon = el.querySelector('svg');
            txt.textContent = msg;
            el.classList.remove('hidden');
            el.className = `fixed top-4 right-4 bg-white border-2 rounded-xl shadow-lg px-4 py-3 z-50 animate-slide-in ${ok ? 'border-emerald-200 text-emerald-700' : 'border-red-200 text-red-700'}`;
            if (ok) icon.innerHTML = '<path d="M20 6L9 17l-5-5"></path>';
            else icon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>';
            setTimeout(() => el.classList.add('hidden'), 3000);
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

        const getTimeAgo = (dateStr) => {
            const diff = Date.now() - new Date(dateStr).getTime();
            const min = Math.floor(diff / 60000);
            if (min < 1) return 'Agora mesmo';
            if (min < 60) return `${min} min atrÃ¡s`;
            const h = Math.floor(min / 60);
            if (h < 24) return `${h}h atrÃ¡s`;
            return new Date(dateStr).toLocaleDateString('pt-BR');
        };

        const getPaymentLabel = (method) => {
            const map = { 'pix': 'PIX', 'card': 'CartÃ£o', 'cash': 'Dinheiro' };
            return map[method] || method || 'NÃ£o inf.';
        };

        const getDeliveryStatusLabel = (status) => {
            const map = {
                'pending': 'Pendente', 'preparing': 'Preparando', 'ready_for_pickup': 'Pronto',
                'in_transit': 'Em TrÃ¢nsito', 'out_for_delivery': 'Saiu p/ Entrega',
                'delivered': 'Entregue', 'failed': 'Falhou', 'returned': 'Devolvido'
            };
            return map[status] || status;
        };

        // --- API ---
        const getApiBase = () => {
            const port = window.location.port;
            // Se estiver rodando no frontend (3000, 5500, 8080), aponta para o backend (8000)
            return (port === '3000' || port === '5500' || port === '8080') ? 'http://localhost:8000' : '';
        };

        async function fetchOrders() {
            if (isFetching) return;
            isFetching = true;
            try {
                const API_BASE = getApiBase();
                const res = await fetch(`${API_BASE}/api/orders`);
                if (res.ok) {
                    const data = await res.json();
                    orders = data.orders || [];
                } else {
                    console.warn('API Error, using mock');
                    orders = mockOrders;
                }
            } catch (e) {
                console.error('Fetch Error', e);
                orders = mockOrders;
            } finally {
                const sig = JSON.stringify(orders.map(o => `${o.id}-${o.status}-${o.delivery_status}`));
                if (sig !== lastOrdersSignature) {
                    renderOrders();
                    updateStats();
                    lastOrdersSignature = sig;
                } else {
                    updateTimeAgo();
                }
                isFetching = false;
            }
        }

        // --- Render ---
        function renderOrders() {
            const listEl = document.getElementById('ordersList');
            const emptyEl = document.getElementById('emptyState');
            const urlParams = new URLSearchParams(window.location.search);
            const specificId = urlParams.get('pedido');

            let filtered = orders;

            if (specificId) {
                filtered = orders.filter(o => String(o.id) === specificId);
                document.getElementById('specificOrderBanner').classList.remove('hidden');
                document.getElementById('specificOrderNumber').textContent = specificId;
                document.getElementById('filtersSection').classList.add('hidden');
                document.getElementById('statsGrid').classList.add('hidden');
            } else {
                document.getElementById('specificOrderBanner').classList.add('hidden');
                document.getElementById('filtersSection').classList.remove('hidden');
                document.getElementById('statsGrid').classList.remove('hidden');
                if (currentFilter !== 'todos') {
                    filtered = orders.filter(o => o.status === currentFilter);
                }
            }

            if (filtered.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            listEl.innerHTML = filtered.map(o => createCardHTML(o)).join('');
        }

        function createCardHTML(order) {
            const statusConfig = {
                pendente: { label: 'Pendente', class: 'status-pendente', icon: '<circle cx="12" cy="12" r="10"></circle>' },
                confirmado: { label: 'Confirmado', class: 'status-confirmado', icon: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' },
                preparando: { label: 'Preparando', class: 'status-preparando', icon: '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>' },
                enviado: { label: 'Em Entrega', class: 'status-enviado', icon: '<rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>' },
                entregue: { label: 'Entregue', class: 'status-entregue', icon: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' },
                cancelado: { label: 'Cancelado', class: 'status-cancelado', icon: '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>' }
            };
            const st = statusConfig[order.status] || statusConfig.pendente;
            const timeAgo = getTimeAgo(order.createdAt);

            return `
                <div class="order-card bg-white rounded-2xl p-5 shadow-sm border border-gray-100" data-id="${order.id}">
                    <div class="flex flex-col md:flex-row md:items-start justify-between gap-4 mb-4">
                        <div>
                            <div class="flex items-center gap-3 mb-1">
                                <h3 class="text-lg font-bold text-gray-800">#${order.order_number || order.id}</h3>
                                <span class="status-badge ${st.class}">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${st.icon}</svg>
                                    ${st.label}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 flex items-center gap-1">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                <span class="time-ago">${timeAgo}</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900">${formatCurrency(order.total)}</p>
                            <p class="text-xs text-gray-500 uppercase font-semibold tracking-wide">${getPaymentLabel(order.paymentMethod)}</p>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <!-- Customer -->
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 shrink-0">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800 text-sm">${order.customer.name}</p>
                                    <p class="text-xs text-gray-600">${order.customer.phone}</p>
                                    <p class="text-xs text-gray-500 mt-1 leading-tight">${order.customer.address}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Items -->
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Itens do Pedido</h4>
                            <ul class="space-y-1">
                                ${order.items.map(i => `
                                    <li class="flex justify-between text-sm">
                                        <span class="text-gray-700"><span class="font-bold text-gray-900">${i.quantity}x</span> ${i.name}</span>
                                        <span class="text-gray-500">${formatCurrency(i.price * i.quantity)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap items-center justify-between gap-3 pt-4 border-t border-gray-100">
                        <div class="flex items-center gap-2">
                            ${order.status !== 'pendente' && order.status !== 'cancelado' ? `
                                <div class="relative">
                                    <select onchange="updateDeliveryStatus(${order.id}, this.value)" class="appearance-none bg-white border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full pl-3 pr-8 py-2 cursor-pointer hover:border-gray-300 transition-colors">
                                        <option value="pending" ${!order.delivery_status || order.delivery_status === 'pending' ? 'selected' : ''}>Entrega Pendente</option>
                                        <option value="preparing" ${order.delivery_status === 'preparing' ? 'selected' : ''}>ðŸ“¦ Preparando</option>
                                        <option value="out_for_delivery" ${order.delivery_status === 'out_for_delivery' ? 'selected' : ''}>ðŸšš Saiu p/ Entrega</option>
                                        <option value="delivered" ${order.delivery_status === 'delivered' ? 'selected' : ''}>ðŸŽ‰ Entregue</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex gap-2">
                            ${order.status === 'pendente' ? `
                                <button onclick="updateStatus(${order.id}, 'confirmado')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition-colors flex items-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    Aceitar
                                </button>
                                <button onclick="updateStatus(${order.id}, 'cancelado')" class="bg-white border border-gray-200 hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-gray-600 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                                    Recusar
                                </button>
                            ` : ''}
                            
                            ${order.status === 'confirmado' ? `
                                <button onclick="updateStatus(${order.id}, 'enviado')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition-colors flex items-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                                    Enviar
                                </button>
                            ` : ''}

                            ${order.status === 'enviado' ? `
                                <button onclick="updateStatus(${order.id}, 'entregue')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition-colors flex items-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    Confirmar Entrega
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const counts = { pendente: 0, confirmado: 0, enviado: 0, entregue: 0 };
            orders.forEach(o => {
                if (counts[o.status] !== undefined) counts[o.status]++;
            });
            document.getElementById('statPendente').textContent = counts.pendente;
            document.getElementById('statConfirmado').textContent = counts.confirmado;
            document.getElementById('statEnviado').textContent = counts.enviado;
            document.getElementById('statEntregue').textContent = counts.entregue;
        }

        function updateTimeAgo() {
            document.querySelectorAll('.order-card').forEach(card => {
                const id = card.getAttribute('data-id');
                const order = orders.find(o => o.id == id);
                if (order) {
                    const el = card.querySelector('.time-ago');
                    if (el) el.textContent = getTimeAgo(order.createdAt);
                }
            });
        }

        // --- Actions ---
        window.updateStatus = async (id, status) => {
            try {
                const API_BASE = getApiBase();
                const res = await fetch(`${API_BASE}/api/orders/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (res.ok) {
                    showToast(`Pedido #${id} atualizado para ${status}`);
                    fetchOrders();
                } else {
                    showToast('Erro ao atualizar status', false);
                }
            } catch (e) {
                console.error(e);
                showToast('Erro de conexÃ£o', false);
            }
        };

        window.updateDeliveryStatus = async (id, status) => {
            try {
                const API_BASE = getApiBase();
                const res = await fetch(`${API_BASE}/api/orders/${id}/delivery-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delivery_status: status })
                });
                if (res.ok) {
                    showToast('Status de entrega atualizado');
                    fetchOrders(); // Refresh to ensure sync
                } else {
                    showToast('Erro ao atualizar entrega', false);
                }
            } catch (e) {
                console.error(e);
                showToast('Erro de conexÃ£o', false);
            }
        };

        // --- Events ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchOrders();
            setInterval(fetchOrders, 10000); // Polling every 10s

            document.querySelectorAll('.filter-chip').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(b => {
                        b.classList.remove('active', 'bg-emerald-50', 'text-emerald-700', 'border-emerald-200');
                        b.classList.add('border-gray-200', 'text-gray-600');
                    });
                    btn.classList.add('active');
                    currentFilter = btn.getAttribute('data-status');
                    renderOrders();
                });
            });
        });

    </script>
</body>

</html>