<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Imagens de Produtos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .info-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .info-box h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .info-box code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.2);
        }
        
        .product-image-container {
            position: relative;
            width: 100%;
            height: 250px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image-container img {
            transform: scale(1.05);
        }
        
        .product-image-container.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        
        .status-badge.success {
            background: #10b981;
            color: white;
        }
        
        .status-badge.error {
            background: #ef4444;
            color: white;
        }
        
        .status-badge.loading {
            background: #f59e0b;
            color: white;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .product-url {
            font-size: 11px;
            color: #6b7280;
            word-break: break-all;
            background: #f9fafb;
            padding: 8px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-top: 8px;
        }
        
        .load-time {
            font-size: 12px;
            color: #10b981;
            margin-top: 5px;
        }
        
        .error-message {
            font-size: 12px;
            color: #ef4444;
            margin-top: 5px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .controls input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .controls button:hover {
            background: #5568d3;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            flex: 1;
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Teste de Imagens de Produtos</h1>
        
        <div class="info-box">
            <h2>‚ÑπÔ∏è Informa√ß√µes</h2>
            <p>Esta p√°gina testa o carregamento de imagens dos produtos do cat√°logo.</p>
            <p style="margin-top: 10px;">
                <strong>URL da API:</strong> <code id="apiUrl">http://localhost:8000</code>
            </p>
            <p style="margin-top: 5px;">
                <strong>Session ID:</strong> <code id="sessionIdDisplay">N√£o fornecido</code>
            </p>
        </div>
        
        <div class="controls">
            <input type="text" id="sessionIdInput" placeholder="Digite o Session ID (opcional)">
            <button onclick="loadProducts()">üîÑ Carregar Produtos</button>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="successCount" style="color: #10b981;">0</div>
                    <div class="stat-label">Sucesso</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="errorCount" style="color: #ef4444;">0</div>
                    <div class="stat-label">Erro</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgLoadTime">0ms</div>
                    <div class="stat-label">Tempo M√©dio</div>
                </div>
            </div>
        </div>
        
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let stats = {
            total: 0,
            success: 0,
            error: 0,
            loadTimes: []
        };

        function updateStats() {
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('errorCount').textContent = stats.error;
            
            const avgTime = stats.loadTimes.length > 0 
                ? Math.round(stats.loadTimes.reduce((a, b) => a + b, 0) / stats.loadTimes.length)
                : 0;
            document.getElementById('avgLoadTime').textContent = avgTime + 'ms';
        }

        function createProductCard(product, index) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.id = `product-${index}`;
            
            const imageUrl = product.imagem_url || './public/padrao.png';
            
            card.innerHTML = `
                <div class="product-image-container loading" id="img-container-${index}">
                    <span class="status-badge loading" id="status-${index}">‚è≥ Carregando</span>
                    <img id="img-${index}" alt="${product.descricao}">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.descricao}</div>
                    <div class="product-url" id="url-${index}">${imageUrl}</div>
                    <div id="info-${index}"></div>
                </div>
            `;
            
            return card;
        }

        function testImage(product, index) {
            const img = document.getElementById(`img-${index}`);
            const container = document.getElementById(`img-container-${index}`);
            const status = document.getElementById(`status-${index}`);
            const info = document.getElementById(`info-${index}`);
            
            const imageUrl = product.imagem_url || './public/padrao.png';
            const startTime = Date.now();
            
            img.onload = function() {
                const loadTime = Date.now() - startTime;
                container.classList.remove('loading');
                status.className = 'status-badge success';
                status.textContent = '‚úÖ OK';
                info.innerHTML = `<div class="load-time">Carregado em ${loadTime}ms</div>`;
                
                stats.success++;
                stats.loadTimes.push(loadTime);
                updateStats();
            };
            
            img.onerror = function() {
                container.classList.remove('loading');
                status.className = 'status-badge error';
                status.textContent = '‚ùå Erro';
                info.innerHTML = `<div class="error-message">Falha ao carregar imagem</div>`;
                
                // Tentar fallback
                if (!this.src.includes('padrao.png')) {
                    console.log('Tentando fallback para:', product.descricao);
                    this.src = './public/padrao.png';
                } else {
                    stats.error++;
                    updateStats();
                }
            };
            
            img.src = imageUrl;
        }

        async function loadProducts() {
            const sessionIdInput = document.getElementById('sessionIdInput');
            const sessionId = sessionIdInput.value || new URLSearchParams(window.location.search).get('sessao_id');
            
            document.getElementById('sessionIdDisplay').textContent = sessionId || 'N√£o fornecido';
            
            // Reset stats
            stats = { total: 0, success: 0, error: 0, loadTimes: [] };
            updateStats();
            
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">‚è≥ Carregando produtos...</p>';
            
            if (!sessionId) {
                grid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">‚ö†Ô∏è Por favor, forne√ßa um Session ID</p>';
                return;
            }
            
            try {
                const url = `${API_BASE}/api/produtos/${sessionId}`;
                console.log('Carregando produtos de:', url);
                
                const res = await fetch(url);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('Produtos recebidos:', data);
                
                if (!data.produtos || data.produtos.length === 0) {
                    grid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">üì¶ Nenhum produto encontrado</p>';
                    return;
                }
                
                stats.total = data.produtos.length;
                updateStats();
                
                grid.innerHTML = '';
                
                data.produtos.forEach((product, index) => {
                    const card = createProductCard(product, index);
                    grid.appendChild(card);
                    
                    // Testar imagem ap√≥s um pequeno delay
                    setTimeout(() => testImage(product, index), index * 100);
                });
                
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                grid.innerHTML = `<p style="color: white; text-align: center; grid-column: 1/-1;">‚ùå Erro: ${error.message}</p>`;
            }
        }

        // Carregar automaticamente se houver sessao_id na URL
        window.addEventListener('load', () => {
            const sessionId = new URLSearchParams(window.location.search).get('sessao_id');
            if (sessionId) {
                document.getElementById('sessionIdInput').value = sessionId;
                loadProducts();
            }
        });
    </script>
</body>
</html>
